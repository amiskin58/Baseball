<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>專業棒球紀錄器 v4.6.8（移除匯入/匯出）</title>
  <style>
    html, body { position: fixed; overflow: hidden; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; background: #1a1a1a; color: white; margin: 0; }
    * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    .layer-1 { width: 100%; background: #222; overflow-x: auto; border-bottom: 1px solid #444; }
    .linescore { width: 100%; border-collapse: collapse; font-size: 10px; text-align: center; table-layout: fixed; min-width: 360px; }
    .linescore td { border: 1px solid #333; padding: 6px 0; height: 24px; }
    .s-cell { font-weight: 800; color: #f1c40f; }

    .layer-2 { display: flex; background: #111; padding: 9px 5px; border-bottom: 1px solid #444; height: 76px; }
    .info-column { flex: 1; padding: 0 5px; border-left: 1px solid #333; display: flex; flex-direction: column; justify-content: center; }
    .info-main { font-size: 13px; font-weight: 800; }
    .info-sub { font-size: 10px; color: #aaa; margin-top: 3px; line-height: 1.08; }

    .layer-3 { display: flex; justify-content: space-around; align-items: center; background: #222; padding: 8px 5px; border-bottom: 1px solid #444; }
    .stat-item { font-size: 14px; font-weight: 900; cursor: pointer; user-select:none; }
    .dots { margin-left: 5px; letter-spacing: 2px; font-size: 16px; }
    .undo-text { font-size: 20px; color: #888; padding-left: 10px; border-left: 1px solid #444; }

    .layer-4 { position: relative; width: 100vw; max-width: 520px; aspect-ratio: 1 / 1; background: #222; margin: auto; overflow: hidden; }
    .field-bg { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 1; transform: scale(1.1); transform-origin: center 75%; }

    .diamond-overlay { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
    .base { position: absolute; width: 22px; height: 22px; background: rgba(90,90,90,0.95); border: 1.5px solid #777; transition: 0.2s; z-index: 10; pointer-events: auto; }
    #base-1 { top: 69.5%; left: 74%; transform: translate(-50%, -50%) rotate(45deg); }
    #base-2 { top: 46%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); }
    #base-3 { top: 69.5%; left: 26%; transform: translate(-50%, -50%) rotate(45deg); }
    #base-home { top: 93%; left: 50%; transform: translateX(-50%); width: 28px; height: 28px; background: #666; clip-path: polygon(0% 0%, 100% 0%, 100% 50%, 50% 100%, 0% 50%); border:none; pointer-events:none; }

    .base.occupied { background: #f1c40f; border-color: #fff; box-shadow: 0 0 12px #f1c40f; }
    .runner-tag { position: absolute; background: #000; color: #f1c40f; padding: 2px 4px; border-radius: 4px; font-size: 11px; font-weight: 900; border: 1.5px solid #f1c40f; white-space: nowrap; z-index: 20; transform: rotate(-45deg); top: -25px; left: -5px; display: none; }

/* 內野球員資訊標籤（投手/打者可共用） */
.player-tag{
  position:absolute;
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 900;
  letter-spacing: .3px;
  z-index: 30;
  pointer-events: none;
  white-space: nowrap;
  box-shadow: 0 6px 16px rgba(0,0,0,0.35);
}

/* 投手：藍色系（與打者區分） */
.pitcher-tag{
  background: rgba(20, 32, 45, 0.92);
  color: #8fd3ff;
  border: 1.5px solid rgba(143, 211, 255, 0.75);
}

    #points-layer { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
    .hit-point { position: absolute; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 900; color: white; transform: translate(-50%, -50%); border: 1px solid rgba(255,255,255,0.4); }
    .point-H { background: #3498db; } .point-O { background: #e74c3c; } .point-F { background: #f39c12; } .point-E { background: #9b59b6; }
    .click-capture { position: absolute; inset: 0; z-index: 4; cursor: crosshair; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 1000; }
    .notice-content { background: white; color: #333; padding: 20px; border-radius: 15px; text-align: center; max-width: 420px; margin: 40px auto; }
    .sheet { position: absolute; left: 0; right: 0; bottom: 0; background: #111; color: white; border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 12px 12px 16px; box-shadow: 0 -10px 30px rgba(0,0,0,0.4); max-height: 82vh; overflow: auto; animation: slideUp 160ms ease-out; }
    @keyframes slideUp { from { transform: translateY(24px); opacity: 0.7; } to { transform: translateY(0); opacity: 1; } }
    .sheet-handle { width: 44px; height: 4px; background: #333; border-radius: 99px; margin: 0 auto 10px; }
    .sheet-title { display:flex; align-items:center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .sheet-title h3 { margin: 0; font-size: 14px; color: #f1c40f; }
    .sheet-sub { font-size: 11px; color:#aaa; }

    .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .menu-btn { width: 100%; padding: 14px 10px; border: none; border-radius: 10px; font-weight: 900; color: white; font-size: 16px; cursor: pointer; user-select:none; }
    .menu-btn.secondary { background:#2b2b2b; color:#ddd; font-weight: 800; }
    .menu-btn:active, .meta-btn:active, .def-btn:active, .mini-btn:active { transform: scale(0.99); }

    .mini-row { display:flex; gap: 8px; margin-top: 10px; }
    .mini-btn { flex: 1; padding: 10px 8px; border-radius: 10px; border: 1px solid #333; background: #1c1c1c; color: #ddd; font-weight: 900; font-size: 12px; cursor: pointer; }
    .mini-btn.active { border-color: #f1c40f; color: #111; background: #f1c40f; }

    .section { margin-top: 12px; padding-top: 12px; border-top: 1px solid #222; }
    .section-title { display:flex; align-items:center; justify-content: space-between; font-size: 12px; color:#bbb; margin-bottom: 8px; }

    .def-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .def-btn { padding: 12px 8px; border-radius: 10px; border: 1px solid #333; background: #1c1c1c; color: #ddd; font-weight: 900; cursor: pointer; user-select:none; }
    .def-btn.suggest { border-color: #e67e22; box-shadow: 0 0 0 1px rgba(230,126,34,0.25) inset; }
    .def-btn.active { background: #e67e22; border-color: #e67e22; color: #111; }

    .primary-cta { margin-top: 10px; display:flex; gap: 8px; }
    .primary-cta .menu-btn { font-size: 15px; padding: 12px 10px; border-radius: 12px; }

    .choice-pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: #1b1b1b; border: 1px solid #2c2c2c; color: #ddd; font-size: 12px; }

    .meta-bar { display:flex; align-items:center; justify-content: space-between; padding: 6px 10px; border-bottom: 1px solid #333; background:#151515; font-size: 11px; color:#bbb; gap: 10px; }
    .meta-left { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid #2c2c2c; background:#101010; color:#ddd; font-weight: 900; }
    .pill.warn { border-color:#c0392b; color:#fff; background:#c0392b; }
    .meta-btn { padding: 6px 10px; border-radius: 10px; border: 1px solid #333; background:#1c1c1c; color:#ddd; font-weight: 900; cursor:pointer; user-select:none; white-space: nowrap; }
    .meta-btn.danger { background:#c0392b; border-color:#c0392b; color:#fff; }

    .radio-row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .radio-pill { display:flex; align-items:center; gap: 6px; border: 1px solid #333; background:#1c1c1c; color:#ddd; padding: 8px 10px; border-radius: 999px; font-weight: 900; font-size: 12px; cursor: pointer; user-select:none; }
    .radio-pill.active { background:#f1c40f; color:#111; border-color:#f1c40f; }

.batter-tag{
  position: absolute;
  z-index: 25;
  left: 50%;
  top: calc(95% - 34px); /* 本壘在 95%，往上移一點 */
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  color: #f1c40f;
  border: 1.5px solid #f1c40f;
  border-radius: 10px;
  padding: 4px 8px;
  font-size: 12px;
  font-weight: 900;
  white-space: nowrap;
  pointer-events: none; /* 不擋點擊/長按 */
  max-width: 90%;
  text-overflow: ellipsis;
  overflow: hidden;
}

.layer1-config {
  padding: 8px 10px;
  border-bottom: 1px solid #333;
  background: #1b1b1b;
  font-size: 12px;
  color: #ddd;
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items:center;
}
.layer1-config b { color:#f1c40f; }
.layer1-config .k { color:#aaa; font-weight:800; }
.layer1-config .v { font-weight:900; }

/* iOS 點不到的保險：radio-pill 改成 button */
button.radio-pill{
  appearance: none;
  -webkit-appearance: none;
  border: 1px solid #333;
  background:#1c1c1c;
  color:#ddd;
  padding: 8px 10px;
  border-radius: 999px;
  font-weight: 900;
  font-size: 12px;
  cursor: pointer;
  user-select:none;
  pointer-events: auto;
}
button.radio-pill.active{
  background:#f1c40f;
  color:#111;
  border-color:#f1c40f;
}

/* 確保 modal 不被其它層蓋住 */
#pregame-modal{ z-index: 5000; pointer-events:auto; }
#pregame-modal .sheet{ z-index: 5001; pointer-events:auto; }

  </style>
</head>
<body>
  <div id="notice-modal" class="modal">
    <div class="notice-content">
      <h2 id="notice-title" style="color:#e67e22; margin:0 0 8px;">提示</h2>
      <p id="notice-body" style="margin:0 0 12px;"></p>
      <button id="notice-btn" class="menu-btn secondary" onclick="closeNoticeModal()">確定</button>
    </div>
  </div>

<!-- 賽前賽制選擇（Pre-Game Setup） -->
<div id="pregame-modal" class="modal" style="display:block;">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>

    <div class="sheet-title">
      <div>
        <h3>賽前設定</h3>
        <div class="sheet-sub">選擇賽制後才進入比賽畫面</div>
      </div>
      <div class="choice-pill" id="pregame-pill">未套用</div>
    </div>

    <!-- 局數制 -->
    <div class="section" style="margin-top:0; padding-top:0; border-top:none;">
      <div class="section-title">
        <span>局數制</span>
        <span style="color:#666;font-size:11px;">（二選一）</span>
      </div>
      <div class="radio-row">
        <button type="button" class="radio-pill" id="pg-inn-7" onclick="setPregameInnings(7)">7局</button>
        <button type="button" class="radio-pill" id="pg-inn-9" onclick="setPregameInnings(9)">9局</button>
      </div>
    </div>

    <!-- 時間制 -->
    <div class="section">
      <div class="section-title">
        <span>時間制</span>
        <span style="color:#666;font-size:11px;">（三選一；無限制＝0）</span>
      </div>
      <div class="radio-row">
        <button type="button" class="radio-pill" id="pg-t-90" onclick="setPregameTimes(90)">90分鐘</button>
        <button type="button" class="radio-pill" id="pg-t-120" onclick="setPregameTimes(120)">120鐘</button>
        <button type="button" class="radio-pill" id="pg-t-0" onclick="setPregameTimes(0)">無限制</button>
      </div>
      <div style="margin-top:8px; font-size:12px; color:#aaa; line-height:1.5;">
        • 若選「無限制」，計時不觸發時間到結束（仍可手動結束/或局數到結束）。<br>
      </div>
    </div>

    <!-- 提前結束條件 -->
    <div class="section">
      <div class="section-title">
        <span>提前結束（輸入 0 表示該條件停用）</span>
        <span style="color:#666;font-size:11px;">（分差）</span>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div style="border:1px solid #222; border-radius:12px; padding:10px;">
          <div style="font-size:12px;color:#bbb;margin-bottom:6px;">3局（完成3局）差</div>
          <input id="pg-rr-3" type="number" inputmode="numeric" min="0" value="0"
                 style="width:100%; padding:12px; border-radius:10px; border:1px solid #333; background:#0f0f0f; color:#fff; font-weight:900; font-size:16px;" />
        </div>
        <div style="border:1px solid #222; border-radius:12px; padding:10px;">
          <div style="font-size:12px;color:#bbb;margin-bottom:6px;">4局（完成4局）差</div>
          <input id="pg-rr-4" type="number" inputmode="numeric" min="0" value="10"
                 style="width:100%; padding:12px; border-radius:10px; border:1px solid #333; background:#0f0f0f; color:#fff; font-weight:900; font-size:16px;" />
        </div>
        <div style="border:1px solid #222; border-radius:12px; padding:10px;">
          <div style="font-size:12px;color:#bbb;margin-bottom:6px;">5局（完成5局）差</div>
          <input id="pg-rr-5" type="number" inputmode="numeric" min="0" value="7"
                 style="width:100%; padding:12px; border-radius:10px; border:1px solid #333; background:#0f0f0f; color:#fff; font-weight:900; font-size:16px;" />
        </div>
        <div style="border:1px solid #222; border-radius:12px; padding:10px;">
          <div style="font-size:12px;color:#bbb;margin-bottom:6px;">6局（完成6局）差</div>
          <input id="pg-rr-6" type="number" inputmode="numeric" min="0" value="0"
                 style="width:100%; padding:12px; border-radius:10px; border:1px solid #333; background:#0f0f0f; color:#fff; font-weight:900; font-size:16px;" />
        </div>
      </div>

      <div style="margin-top:10px; font-size:12px; color:#aaa; line-height:1.5;">
        • 觸發判定依你原本邏輯：完成該局後，分差 ≥ 設定值即提前結束。<br>
      </div>

      <div class="primary-cta">
        <button class="menu-btn" style="background:#16a085;" onclick="applyPregameSettings()">確認並開始比賽</button>
      </div>
    </div>
  </div>
</div>

<div id="game-ui" style="display:none;">
    <div class="meta-bar">
      <div class="meta-left">
        <span class="pill" id="pill-format">賽制：7局 / 120分鐘</span>
        <span class="pill" id="pill-timer">用時：00:00 / 120</span>
        <span class="pill" id="pill-runrule">提前結束：4局10分 / 5局7分</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="meta-btn" onclick="openSettings()">賽制設定</button>
        <button class="meta-btn danger" id="end-game-btn" onclick="showEndGameNotice()" style="display:none;">比賽結束</button>
      </div>
    </div>

    <div class="layer-1" id="linescore-wrap"></div>

    <div class="layer-2">
      <div class="info-column">
        <div style="font-size:9px;color:#888;">PITCHER</div>
        <div class="info-main">#11 守方</div>
        <div class="info-sub" id="p-pitches" style="color:#f1c40f">P: 0</div>
      </div>
      <div class="info-column">
        <div style="font-size:9px;color:#888;">BATTER</div>
        <div class="info-main" id="b-main">第1棒 #10</div>
        <div class="info-sub" id="b-stats">AVG: .000<br>--</div>
      </div>
      <div class="info-column">
        <div style="font-size:9px;color:#888;">NEXT</div>
        <div class="info-main" id="n-main">第2棒 #20</div>
        <div class="info-sub" id="n-stats">AVG: .000<br>--</div>
      </div>
    </div>

    <div class="layer-3">
      <div class="stat-item" style="color:#f1c40f" id="disp-inning">1上</div>
      <div class="stat-item" onclick="handleBall()">B <span class="dots" id="dots-B"></span></div>
      <div class="stat-item" onclick="handleStrike()">S <span class="dots" id="dots-S"></span></div>
      <div class="stat-item">O <span class="dots" id="dots-O"></span></div>
      <div class="stat-item undo-text" onclick="undo()">↺</div>
    </div>

    <div class="layer-4">
      <svg class="field-bg" viewBox="0 0 100 100">
        <rect width="100" height="100" fill="#a67c52" />
        <path d="M 50 95 L -20 25 A 100 100 0 0 1 120 25 L 50 95" fill="#2d5a27" />
        <path d="M 15 85 L 15 60 A 38 38 0 0 1 85 60 L 85 85 L 50 95 Z" fill="#a67c52" />
        <path d="M 50 95 L 25 70 L 50 45 L 75 70 Z" fill="#2d5a27" stroke="white" stroke-width="0.3" />
        <line x1="50" y1="95" x2="-20" y2="25" stroke="white" stroke-width="0.8" />
        <line x1="50" y1="95" x2="120" y2="25" stroke="white" stroke-width="0.8" />
      </svg>

      <div id="points-layer"></div>

      <div class="diamond-overlay">

  <!-- 投手標籤（投手丘附近） -->
  <div id="pitcher-tag" class="player-tag pitcher-tag"
       style="left:50%; top:69%; transform:translate(-50%,-50%);">
    #-- 投手
  </div>
        <div id="base-home" class="base"></div>
  <div id="batter-tag" class="batter-tag"></div>
        <div id="base-1" class="base" data-base="1"><div id="rtag-1" class="runner-tag"></div></div>
        <div id="base-2" class="base" data-base="2"><div id="rtag-2" class="runner-tag"></div></div>
        <div id="base-3" class="base" data-base="3"><div id="rtag-3" class="runner-tag"></div></div>


      </div>

      <div class="click-capture" onclick="handleMapClick(event)"></div>
    </div>
  </div>

  <!-- 合併 modal：界內 -->
  <div id="fair-sheet-modal" class="modal" onclick="backdropClose(event, 'fair-sheet-modal')">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheet-handle"></div>

      <div class="sheet-title">
        <div>
          <h3>擊球結果（界內）</h3>
          <div class="sheet-sub" id="fair-loc-text">落點：x=50 y=80</div>
        </div>
        <div class="choice-pill" id="fair-choice-pill">尚未選擇</div>
      </div>

      <div class="btn-row">
        <button class="menu-btn" style="background:#3498db;" onclick="pickPlayNeedingFielder('1H', 1, 'hit')">一壘安打</button>
        <button class="menu-btn" style="background:#2980b9;" onclick="pickPlayNeedingFielder('2H', 2, 'hit')">二壘安打</button>
        <button class="menu-btn" style="background:#2471a3;" onclick="pickPlayNeedingFielder('3H', 3, 'hit')">三壘安打</button>
        <button class="menu-btn" style="background:#c0392b;" onclick="execPlay('HR', 4, 'hit', {recordPoint:true, countPitch:true, saveHist:true})">全壘打</button>

        <button class="menu-btn" style="background:#e74c3c;" onclick="pickPlayNeedingFielder('O', 0, 'out')">出局</button>
        <button class="menu-btn" style="background:#9b59b6;" onclick="openErrorBasesChooser()">失誤（E）</button>
      </div>

      <div class="section" id="error-bases-section" style="display:none;">
        <div class="section-title">
          <span>失誤進壘（E1/E2/E3）</span>
          <span style="color:#666;font-size:11px;">（選擇打者最終到達壘包）</span>
        </div>
        <div class="btn-row">
          <button class="menu-btn" style="background:#8e44ad;" onclick="pickPlayNeedingFielder('E1', 1, 'error')">E1（上一壘）</button>
          <button class="menu-btn" style="background:#8e44ad;" onclick="pickPlayNeedingFielder('E2', 2, 'error')">E2（上二壘）</button>
          <button class="menu-btn" style="background:#8e44ad;" onclick="pickPlayNeedingFielder('E3', 3, 'error')">E3（上三壘）</button>
          <button class="menu-btn secondary" onclick="hideErrorBasesChooser()">取消</button>
        </div>
      </div>

      <div class="section" id="fair-detail-section" style="display:none;">
        <div class="section-title">
          <span>擊球型態</span>
          <span style="color:#666;font-size:11px;">（可不選）</span>
        </div>

        <div class="mini-row">
          <button class="mini-btn" id="suffix-gb" onclick="setSuffixUI('滾地')">滾地</button>
          <button class="mini-btn" id="suffix-ld" onclick="setSuffixUI('平飛')">平飛</button>
          <button class="mini-btn" id="suffix-fb" onclick="setSuffixUI('高飛')">高飛</button>
        </div>

        <div class="section-title" style="margin-top:12px;">
          <span>守備處理球員</span>
          <span style="color:#666;font-size:11px;">（建議者已高亮）</span>
        </div>

        <div id="def-grid" class="def-grid"></div>

        <div class="primary-cta">
          <button class="menu-btn" style="background:#e67e22;" onclick="confirmCombinedPlay()">確定紀錄</button>
          <button class="menu-btn secondary" onclick="closeMenus()">取消</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>其他</span>
          <span style="color:#666;font-size:11px;">（不需守備）</span>
        </div>
        <div class="btn-row">
          <button class="menu-btn secondary" onclick="closeMenus()">關閉</button>
          <button class="menu-btn secondary" onclick="showNotice('提示', '保送請用 B 鍵（四球自動 BB）。', false)">保送說明</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 界外 -->
  <div id="foul-menu" class="modal" onclick="backdropClose(event, 'foul-menu')">
    <div class="notice-content" onclick="event.stopPropagation()">
      <h3 style="margin-top:0;">界外區域</h3>
      <button class="menu-btn" style="background:#f39c12;" onclick="execPlay('F', 0, 'foul', {recordPoint:true, countPitch:false, saveHist:true})">界外球</button>
      <button class="menu-btn" style="background:#e74c3c;"
        onclick="execPlay('FO', 0, 'out', {recordPoint:true, countPitch:false, saveHist:true, metaExtra:{isFoulOut:true}})">
        界外接殺
      </button>
      <button class="menu-btn secondary" style="margin-top:10px;" onclick="closeMenus()">取消</button>
    </div>
  </div>

  <!-- 賽制設定 -->
  <div id="settings-modal" class="modal" onclick="backdropClose(event, 'settings-modal')">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheet-handle"></div>
      <div class="sheet-title">
        <div>
          <h3>賽制設定</h3>
          <div class="sheet-sub">時間到處置（120分鐘）</div>
        </div>
        <div class="choice-pill" id="settings-pill">已套用</div>
      </div>

      <div class="section" style="margin-top:0; padding-top:0; border-top:none;">
        <div class="section-title">
          <span>時間到處置</span>
          <span style="color:#666;font-size:11px;">（三選一/手動）</span>
        </div>

        <div class="radio-row">
          <div class="radio-pill" id="pol-immediate" onclick="setTimePolicyUI('immediate')">立即結束</div>
          <div class="radio-pill" id="pol-half" onclick="setTimePolicyUI('endHalf')">完成半局</div>
          <div class="radio-pill" id="pol-inning" onclick="setTimePolicyUI('endInning')">完成該局</div>
          <div class="radio-pill" id="pol-manual" onclick="setTimePolicyUI('manual')">顯示按鈕手動</div>
        </div>

        <div style="margin-top:10px; font-size:12px; color:#aaa; line-height:1.5;">
          • 立即結束：時間到立刻結束並停表。<br>
          • 完成半局：時間到後，等下一次「攻守交換」才結束。<br>
          • 完成該局：時間到後，等該局下半打完才結束。<br>
          • 顯示按鈕手動：時間到顯示「比賽結束」按鈕，由你決定何時結束。
        </div>

        <div class="primary-cta">
          <button class="menu-btn" style="background:#16a085;" onclick="applySettings()">套用設定</button>
          <button class="menu-btn secondary" onclick="closeSettings()">關閉</button>
        </div>
      </div>
    </div>
  </div>

<!-- 跑壘事件（盜壘） -->
<div id="runner-event-modal" class="modal" onclick="backdropClose(event, 'runner-event-modal')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>

    <div class="sheet-title">
      <div>
        <h3 id="runner-event-title">跑壘事件</h3>
        <div class="sheet-sub" id="runner-event-sub">壘況：-</div>
      </div>
      <div class="choice-pill" id="runner-event-pill">（盜壘）</div>
    </div>

    <div class="section" style="margin-top:0; padding-top:0; border-top:none;">
      <div class="section-title">
        <span>可用選項</span>
        <span style="color:#666;font-size:11px;">失敗＝+1 出局（不推進打者）</span>
      </div>

      <div class="btn-row" id="runner-event-btns"></div>

      <div class="section">
        <div class="btn-row">
          <button class="menu-btn secondary" onclick="closeRunnerEvent()">關閉</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 跑壘事件（結束） -->

  <script>
    const END_PRI = { manual: 10, inningEnd: 20, homeX: 30, time: 40, mercy: 50, walkoff: 60 };

    let gameConfig = {
      mode: 'innings',
      maxInnings: 7,
      timeLimitMin: 120,
      startTs: Date.now(),
      gameOver: false,
      endReason: "",
      endReasonPriority: 0,
      timeExpired: false,
      timeExpiredPolicy: 'manual',
      timeExpirePending: null,
      runRule: [
        { inningComplete: 4, diff: 10 },
        { inningComplete: 5, diff: 7 }
      ]
    };

    let state = {
      inning: 1, side: '上',
      B: 0, S: 0, O: 0,
      awayScore: Array(9).fill(0),
      homeScore: Array(9).fill(0),
      awayH: 0, homeH: 0,
      awayE: 0, homeE: 0,
      pPitches: { '上': 0, '下': 0 },
      runners: { 1: null, 2: null, 3: null },
      batterIdx: { '上': 1, '下': 1 },
      rosters: { '上': {}, '下': {} },
      points: [],
      homeX: false,
pitchers: {
  '上': { num: 11, name: '守方' }, // 主隊守備（下半）投手；先給預設
  '下': { num: 11, name: '守方' }  // 客隊守備（上半）投手；先給預設
}
    };

    // v4.6.8: plays[]（保留；本版本已移除匯入/匯出）
    let plays = [];
    let playSeq = 1;

    let history = [];
    let lastLoc = { x: 50, y: 80 };
    let lastLocValid = false;

    let pendingPlay = null;
    let currentSuffix = "";
    let selectedFielder = "";
    let lastSuffixMemory = "";

    let timerTick = null;

    let pressTimer = null;
    let pressedBase = null;

    let tmpTimePolicy = null;

    (function init() {
  // roster 先建好（比賽開始後就能用）
  ['上','下'].forEach(s => {
    for (let i=1;i<=9;i++) state.rosters[s][i] = { num: i*10, ab:0, hits:0, res:[] };
  });

  // 預設選項高亮（可改成你要的預設）
  setPregameInnings(7);
  setPregameTime(120);

  // 先不要開賽、不要 buildLinescore、不要 startTimerTick
  // 等使用者按「確認並開始比賽」才套用並進入 game-ui
})();
      buildLinescore(gameConfig.maxInnings);
      bindBaseLongPress();
      updateSettingsUIFromConfig();
      updateUI();
      startTimerTick();
    })();

    function buildLinescore(nInnings) {
  const wrap = document.getElementById('linescore-wrap');
  const cols = [];
  for (let i=1;i<=nInnings;i++) cols.push(i);

  const headerInnings = cols.map(i => `<td>${i}</td>`).join('');
  const awayCells = cols.map(i => `<td class="s-cell" id="as-${i}">-</td>`).join('');
  const homeCells = cols.map(i => `<td class="s-cell" id="hs-${i}">-</td>`).join('');

  const tableHtml = `
    <table class="linescore">
      <tr>
        <td style="color:#f1c40f; width:60px;">客</td>
        ${headerInnings}
        <td style="background:#2d2d2d;width:25px;">R</td>
        <td style="width:25px;">H</td>
        <td style="width:25px;">E</td>
      </tr>
      <tr id="away-data-row">
        <td>客隊</td>
        ${awayCells}
        <td id="away-R">0</td>
        <td id="away-H">0</td>
        <td id="away-E">0</td>
      </tr>
      <tr id="home-data-row">
        <td>主隊</td>
        ${homeCells}
        <td id="home-R">0</td>
        <td id="home-H">0</td>
        <td id="home-E">0</td>
      </tr>
    </table>
  `;

  wrap.innerHTML = tableHtml;
  // 重新插入 layer-1 摘要
  renderLayer1ConfigSummary();
}

    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

    function totalRuns(side){
      const arr = side==='上' ? state.awayScore : state.homeScore;
      return arr.reduce((a,b)=>a+b,0);
    }
    function scoreDiffAbs(){ return Math.abs(totalRuns('上') - totalRuns('下')); }
    function fmtTime(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    }
    function defendingSide(){ return state.side==='上' ? '下' : '上'; }

    function showNotice(title, body, isSwap=false) {
      document.getElementById('notice-title').innerText = title;
      document.getElementById('notice-body').innerHTML = body;
      const btn = document.getElementById('notice-btn');
      btn.dataset.swap = isSwap ? "true" : "false";
      btn.onclick = closeNoticeModal;
      document.getElementById('notice-modal').style.display = 'block';
    }
    function closeNoticeModal() {
      const btn = document.getElementById('notice-btn');
      const isSwap = btn.dataset.swap === "true";
      document.getElementById('notice-modal').style.display = 'none';
      if (isSwap) swapSides('3outs');
      updateUI();
    }

    function openSettings(){
      tmpTimePolicy = gameConfig.timeExpiredPolicy;
      updateTimePolicyPills(tmpTimePolicy);
      document.getElementById('settings-modal').style.display = 'block';
    }
    function closeSettings(){ document.getElementById('settings-modal').style.display = 'none'; }
    function setTimePolicyUI(pol){ tmpTimePolicy = pol; updateTimePolicyPills(pol); }
    function updateTimePolicyPills(pol){
      ['pol-immediate','pol-half','pol-inning','pol-manual'].forEach(id => document.getElementById(id).classList.remove('active'));
      if (pol==='immediate') document.getElementById('pol-immediate').classList.add('active');
      if (pol==='endHalf') document.getElementById('pol-half').classList.add('active');
      if (pol==='endInning') document.getElementById('pol-inning').classList.add('active');
      if (pol==='manual') document.getElementById('pol-manual').classList.add('active');
    }
    function applySettings(){
      saveHist();
      gameConfig.timeExpiredPolicy = tmpTimePolicy || 'manual';
      updateSettingsUIFromConfig();
      closeSettings();
      updateUI();
    }
    function updateSettingsUIFromConfig(){
      const map = { immediate:'立即結束', endHalf:'完成半局', endInning:'完成該局', manual:'顯示按鈕手動' };
      document.getElementById('settings-pill').innerText = map[gameConfig.timeExpiredPolicy] || '已套用';
      updateTimePolicyPills(gameConfig.timeExpiredPolicy);
    }

    function startTimerTick(){
      if (timerTick) clearInterval(timerTick);
      timerTick = setInterval(() => {
        if (gameConfig.gameOver) return;
const elapsed = Date.now() - gameConfig.startTs;
const limitMs = gameConfig.timeLimitMin * 60 * 1000;

// 倒數：剩餘時間
const remainMs = Math.max(0, limitMs - elapsed);

// 15 分鐘警示
const warnMs = 15 * 60 * 1000;
const pillTimer = document.getElementById('pill-timer');
if (remainMs > 0 && remainMs <= warnMs) pillTimer.classList.add('warn');
else pillTimer.classList.remove('warn');

pillTimer.innerText = `剩餘：${fmtTime(remainMs)} / ${gameConfig.timeLimitMin}`;

// 時間到：remainMs === 0（或 elapsed >= limitMs 也可）
if (!gameConfig.timeExpired && remainMs <= 0){
  gameConfig.timeExpired = true;
  const pillTimer = document.getElementById('pill-timer');
  pillTimer.classList.add('warn');

  if (gameConfig.timeExpiredPolicy === 'immediate'){
    setEndReason('時間到（立即結束）', END_PRI.time);
    finalizeGame();
  } else if (gameConfig.timeExpiredPolicy === 'endHalf'){
    gameConfig.timeExpirePending = 'half';
    setEndReason('時間到（完成半局後結束）', END_PRI.time);
    showEndGameButton(true, END_PRI.time);
  } else if (gameConfig.timeExpiredPolicy === 'endInning'){
    gameConfig.timeExpirePending = 'inning';
    setEndReason('時間到（完成該局後結束）', END_PRI.time);
    showEndGameButton(true, END_PRI.time);
  } else {
    setEndReason('時間到（手動結束）', END_PRI.time);
    showEndGameButton(true, END_PRI.time);
  }
}
      }, 250);
    }
    function stopTimerTick(){
      if (timerTick) clearInterval(timerTick);
      timerTick = null;
    }

    function setEndReason(reason, priority){
      if (priority >= (gameConfig.endReasonPriority || 0)){
        gameConfig.endReason = reason;
        gameConfig.endReasonPriority = priority;
      }
    }
    function showEndGameButton(show, priority){
      const btn = document.getElementById('end-game-btn');
      if (!show){ btn.style.display='none'; return; }
      if (priority >= (gameConfig.endReasonPriority || 0)) btn.style.display='inline-block';
      else if (btn.style.display==='none') btn.style.display='inline-block';
    }

    function showEndGameNotice(){
      const a = totalRuns('上');
      const h = totalRuns('下');
      const reason = gameConfig.endReason || '手動結束';
      showNotice('比賽結束', `原因：<b>${reason}</b><br>比數：<b>${a}</b> - <b>${h}</b><br>（按確定即結束並停表）`, false);
      const btn = document.getElementById('notice-btn');
      btn.onclick = () => { document.getElementById('notice-modal').style.display='none'; setEndReason(reason, END_PRI.manual); finalizeGame(); };
    }

    function finalizeGame(){
      gameConfig.gameOver = true;
      stopTimerTick();
      document.getElementById('end-game-btn').style.display = 'inline-block';
      const a = totalRuns('上');
      const h = totalRuns('下');
      showNotice('比賽已結束', `原因：<b>${gameConfig.endReason || '（未指定）'}</b><br>比數：<b>${a}</b> - <b>${h}</b>`, false);
    }

    function handleBall(){
      if (gameConfig.gameOver) return;
      saveHist();
      state.B++;
      state.pPitches[defendingSide()]++;
      recordPlayEvent({ type:'pitch', label:'B', loc:null, meta:{} });

      if (state.B >= 4){
        execPlay('BB', 1, 'special', {recordPoint:false, countPitch:false, saveHist:false});
      } else updateUI();
    }

    function handleStrike(){
      if (gameConfig.gameOver) return;
      saveHist();
      state.S++;
      state.pPitches[defendingSide()]++;
      recordPlayEvent({ type:'pitch', label:'S', loc:null, meta:{} });

      if (state.S >= 3){
        execPlay('K', 0, 'out', {recordPoint:false, countPitch:false, saveHist:false});
      } else updateUI();
    }

    function handleMapClick(e){
      if (gameConfig.gameOver) return;
      const rect = document.querySelector('.layer-4').getBoundingClientRect();
      lastLoc = {
        x: ((e.clientX - rect.left) / rect.width) * 100,
        y: ((e.clientY - rect.top) / rect.height) * 100
      };
      lastLocValid = true;

      document.getElementById('fair-loc-text').innerText = `落點：x=${lastLoc.x.toFixed(1)} y=${lastLoc.y.toFixed(1)}`;

      let dx = lastLoc.x - 50;
      let dy = 95 - lastLoc.y;
      const inFair = dy >= Math.abs(dx) * 1.0 && lastLoc.y <= 95;

      if (inFair){
        resetFairSheet();
        document.getElementById('fair-sheet-modal').style.display = 'block';
      } else {
        document.getElementById('foul-menu').style.display = 'block';
      }
    }

    function backdropClose(e, id){
      if (e.target.id === id) closeMenus();
    }
    function closeMenus(){
      document.getElementById('fair-sheet-modal').style.display = 'none';
      document.getElementById('foul-menu').style.display = 'none';
      document.getElementById('settings-modal').style.display = 'none';
      document.getElementById('base-edit-modal').style.display = 'none';
      pendingPlay = null;
      currentSuffix = "";
      selectedFielder = "";
      hideErrorBasesChooser();

document.getElementById('runner-event-modal').style.display = 'none';
      document.getElementById('fair-detail-section').style.display = 'none';
    }

    function resetFairSheet(){
      pendingPlay = null;
      selectedFielder = "";
      currentSuffix = lastSuffixMemory || "";
      setSuffixUI(currentSuffix, true);
      document.getElementById('fair-choice-pill').innerText = '尚未選擇';
      hideErrorBasesChooser();
      document.getElementById('fair-detail-section').style.display = 'none';
      document.getElementById('def-grid').innerHTML = '';
    }

    function openErrorBasesChooser(){
      document.getElementById('error-bases-section').style.display = 'block';
      document.getElementById('fair-detail-section').style.display = 'none';
    }
    function hideErrorBasesChooser(){
      const sec = document.getElementById('error-bases-section');
      if (sec) sec.style.display = 'none';
    }

    function pickPlayNeedingFielder(label, bases, type){
      pendingPlay = { label, bases, type };
      document.getElementById('fair-choice-pill').innerText = label;
      document.getElementById('fair-detail-section').style.display = 'block';
      hideErrorBasesChooser();
      buildFielderButtons();
    }

    function setSuffixUI(s, init=false){
      currentSuffix = s || "";
      if (!init) lastSuffixMemory = currentSuffix;
      ['suffix-gb','suffix-ld','suffix-fb'].forEach(id => document.getElementById(id).classList.remove('active'));
      if (currentSuffix === '滾地') document.getElementById('suffix-gb').classList.add('active');
      if (currentSuffix === '平飛') document.getElementById('suffix-ld').classList.add('active');
      if (currentSuffix === '高飛') document.getElementById('suffix-fb').classList.add('active');
    }

    function getSuggestedFielders(x, y){
      let suggest = [];
      if (y > 75) suggest = ["C", "P"];
      else if (y > 45){
        if (x < 35) suggest = ["3B", "SS"];
        else if (x > 65) suggest = ["1B", "2B"];
        else suggest = ["P", "2B", "SS"];
      } else {
        if (x < 33) suggest = ["LF", "CF"];
        else if (x > 66) suggest = ["RF", "CF"];
        else suggest = ["CF", "LF", "RF"];
      }
      return suggest;
    }

    function buildFielderButtons(){
      const grid = document.getElementById('def-grid');
      grid.innerHTML = '';
      const all = ["P","C","1B","2B","3B","SS","LF","CF","RF"];
      const suggests = lastLocValid ? getSuggestedFielders(lastLoc.x, lastLoc.y) : ["P","SS","CF"];
      all.forEach(pos => {
        const btn = document.createElement('button');
        btn.className = 'def-btn';
        if (suggests.includes(pos)) btn.classList.add('suggest');
        btn.innerText = pos;
        btn.onclick = () => {
          selectedFielder = pos;
          [...grid.children].forEach(el => el.classList.remove('active'));
          btn.classList.add('active');
        };
        grid.appendChild(btn);
      });
      if (suggests.length){
        const first = suggests[0];
        const idx = all.indexOf(first);
        if (idx >= 0){
          selectedFielder = first;
          grid.children[idx].classList.add('active');
        }
      }
    }

    function confirmCombinedPlay(){
      if (!pendingPlay) return;
      if (!selectedFielder) { showNotice('提示', '請先選擇守備處理球員', false); return; }
      const suffix = currentSuffix || "";
      const finalLabel = suffix ? `${pendingPlay.label}(${suffix}${selectedFielder})` : `${pendingPlay.label}(${selectedFielder})`;
      execPlay(finalLabel, pendingPlay.bases, pendingPlay.type, {recordPoint:true, countPitch:true, saveHist:true});
      closeMenus();
    }

    function snapshotForPlay(){
      return {
        inning: state.inning,
        side: state.side,
        B: state.B, S: state.S, O: state.O,
        runners: deepClone(state.runners),
        awayR: totalRuns('上'),
        homeR: totalRuns('下'),
        awayH: state.awayH,
        homeH: state.homeH,
        awayE: state.awayE,
        homeE: state.homeE,
        batterIdx: deepClone(state.batterIdx),
      };
    }
    function currentBatterInfo(){
      const side = state.side;
      const idx = state.batterIdx[side];
      const b = state.rosters[side][idx];
      return { side, idx, num: b?.num ?? null };
    }
    function recordPlayEvent(ev, beforeSnap=null){
      const before = beforeSnap || snapshotForPlay();
      const batter = currentBatterInfo();
      const after = snapshotForPlay();
      plays.push({
        seq: playSeq++,
        ts: Date.now(),
        type: ev.type,
        label: ev.label,
        inning: before.inning,
        side: before.side,
        batter,
        before,
        after,
        loc: ev.loc || null,
        meta: ev.meta || {}
      });
      if (ev.type === 'play' || ev.type === 'foul') checkWalkoff();
    }
    function recordSwapEvent(reason){
      const snap = snapshotForPlay();
      plays.push({
        seq: playSeq++,
        ts: Date.now(),
        type: "swap",
        label: "SWAP",
        inning: snap.inning,
        side: snap.side,
        batter: currentBatterInfo(),
        before: snap,
        after: snap,
        loc: null,
        meta: {
          reason: reason || "swap",
          endedInning: snap.inning,
          endedSide: snap.side,
          score: { away: snap.awayR, home: snap.homeR }
        }
      });
    }

    function scoreRun(n){
      const arr = state.side === '上' ? state.awayScore : state.homeScore;
      const i = state.inning - 1;
      arr[i] = (arr[i] || 0) + n;
    }

    function placeRunnerWithForce(nR, targetBase, runnerObj, scoreCb){
      let b = targetBase;
      let cur = runnerObj;
      while (b <= 3){
        if (!nR[b]) { nR[b] = cur; return; }
        const occupant = nR[b];
        nR[b] = cur;
        cur = occupant;
        b += 1;
      }
      scoreCb(1);
    }

    function execPlay(label, bases, type, opts={}){
      if (gameConfig.gameOver) return;
      const recordPoint = opts.recordPoint ?? false;
      const countPitch  = opts.countPitch ?? false;
      const saveHistFlag = opts.saveHist ?? false;
      const metaExtra = opts.metaExtra || {};

      if (saveHistFlag) saveHist();
      if (countPitch) state.pPitches[defendingSide()]++;

      if (recordPoint && lastLocValid){
        state.points.push({ ...lastLoc, label, type, side: state.side });
      }

      const side = state.side;
      const batter = state.rosters[side][state.batterIdx[side]];
      const beforeSnap = snapshotForPlay();

if (type === 'hit' || type === 'error' || type === 'special'){

  // 命中/失誤統計（BB 不算 AB、也不算 H/E）
  if (type === 'hit'){
    batter.hits++;
    if (side==='上') state.awayH++; else state.homeH++;
  }
  if (type === 'error'){
    if (side==='上') state.homeE++; else state.awayE++;
  }

  // BB：只推進「被迫」跑者（修正重點）
  if (label === 'BB'){
    batter.res.push(label); // 不算 AB

    let sc = 0;

    // 先保留原壘況，不要先整批 i+bases 推進
    const nR = {1: state.runners[1], 2: state.runners[2], 3: state.runners[3]};

    // 把打者「放上一壘」，若一壘有人就連鎖強迫推進
    placeRunnerWithForce(nR, 1, batter, (n)=> sc += n);

    state.runners = nR;
    if (sc > 0) scoreRun(sc);

    // 打者輪替
    state.batterIdx[side] = (state.batterIdx[side] % 9) + 1;

  } else {
    // 其他（安打/失誤/一般 special）照原本邏輯
    batter.ab++;
    batter.res.push(label);

    let sc = 0;
    const nR = {1:null,2:null,3:null};

    for (let i=3;i>=1;i--){
      if (!state.runners[i]) continue;
      const target = i + bases;
      if (target >= 4) sc++;
      else nR[target] = state.runners[i];
    }

    if (bases >= 4){
      sc++;
    } else if (bases > 0){
      placeRunnerWithForce(nR, bases, batter, (n)=> sc+=n);
    }

    state.runners = nR;
    if (sc>0) scoreRun(sc);

    state.batterIdx[side] = (state.batterIdx[side] % 9) + 1;
  }

} else if (type === 'out'){
        batter.ab++;
        batter.res.push(label);
        addOut();

      } else if (type === 'foul'){
        if (state.S < 2) state.S++;
      }

      recordPlayEvent({
        type: (type==='foul' ? 'foul' : 'play'),
        label,
        loc: recordPoint && lastLocValid ? {x:lastLoc.x, y:lastLoc.y} : null,
        meta: metaExtra
      }, beforeSnap);

      if (type !== 'foul'){ state.B = 0; state.S = 0; }

      updateUI();
    }

function addOut(){
  state.O++;

  // 打者出局：無論是否第3出局，都要讓「本方下一次進攻」從下一棒開始
  state.batterIdx[state.side] = (state.batterIdx[state.side] % 9) + 1;

  if (state.O >= 3){
    const nextSide = state.side === '上' ? '下' : '上';
    showNotice(
      "攻守交換",
      `由 <b>${nextSide==='上'?'客隊':'主隊'}</b><br>第 <b>${state.batterIdx[nextSide]}</b> 棒開始打擊`,
      true
    );
  }
}

    function swapSides(reason){
      recordSwapEvent(reason);
      state.O = 0; state.B = 0; state.S = 0;
      state.runners = {1:null,2:null,3:null};

      if (state.side === '上'){
        if (state.inning === gameConfig.maxInnings && totalRuns('下') > totalRuns('上')){
          state.homeX = true;
          setEndReason('末局上半主隊領先（X）', END_PRI.homeX);
          showEndGameButton(true, END_PRI.homeX);
          finalizeGame();
          return;
        }
        state.side = '下';
      } else {
        state.side = '上';
        state.inning++;
        if (state.inning > gameConfig.maxInnings){
          setEndReason('局數到', END_PRI.inningEnd);
          finalizeGame();
          return;
        }
      }

      if (gameConfig.timeExpired && gameConfig.timeExpirePending){
        if (gameConfig.timeExpirePending === 'half'){
          finalizeGame(); return;
        }
        if (gameConfig.timeExpirePending === 'inning'){
          if (state.side === '上'){ finalizeGame(); return; }
        }
      }

      checkMercyRule();
      updateUI();
    }

    function checkMercyRule(){
      const completed = state.inning - 1;
      const diff = scoreDiffAbs();
      for (const rr of gameConfig.runRule){
        if (completed >= rr.inningComplete && diff >= rr.diff){
          setEndReason(`提前結束（${rr.inningComplete}局差${rr.diff}分）`, END_PRI.mercy);
          showEndGameButton(true, END_PRI.mercy);
          finalizeGame();
          return;
        }
      }
    }

    function checkWalkoff(){
      if (state.side === '下' && state.inning === gameConfig.maxInnings){
        if (totalRuns('下') > totalRuns('上')){
          setEndReason('再見分', END_PRI.walkoff);
          showEndGameButton(true, END_PRI.walkoff);
          finalizeGame();
          return true;
        }
      }
      return false;
    }

    function saveHist(){
      history.push(JSON.stringify({ state, gameConfig, plays, playSeq, lastLoc, lastLocValid, lastSuffixMemory }));
      if (history.length > 200) history.shift();
    }
    function undo(){
      if (!history.length) return;
      const prev = JSON.parse(history.pop());
      state = prev.state;
      gameConfig = prev.gameConfig;
      plays = prev.plays;
      playSeq = prev.playSeq;
      lastLoc = prev.lastLoc;
      lastLocValid = prev.lastLocValid;
      lastSuffixMemory = prev.lastSuffixMemory || "";

      if (gameConfig.gameOver) stopTimerTick(); else startTimerTick();
      updateSettingsUIFromConfig();
      updateUI();
    }

// ===== Pre-Game selections =====
let pregameSel = {
  innings: 7,
  timeMin: 120, // 0 = unlimited
};

function setPregameInnings(n){
alert('clicked innings ' + n);
  pregameSel.innings = n;
  ['pg-inn-7','pg-inn-9'].forEach(id => document.getElementById(id).classList.remove('active'));
  document.getElementById(n===7 ? 'pg-inn-7' : 'pg-inn-9').classList.add('active');
}

function setPregameTime(m){
  pregameSel.timeMin = m;
  ['pg-t-90','pg-t-120','pg-t-0'].forEach(id => document.getElementById(id).classList.remove('active'));
  const map = {90:'pg-t-90',120:'pg-t-120',0:'pg-t-0'};
  document.getElementById(map[m]).classList.add('active');
}

function applyPregameSettings(){
  // 讀取提前結束條件
  const rr3 = Math.max(0, parseInt(document.getElementById('pg-rr-3').value || '0', 10));
  const rr4 = Math.max(0, parseInt(document.getElementById('pg-rr-4').value || '0', 10));
  const rr5 = Math.max(0, parseInt(document.getElementById('pg-rr-5').value || '0', 10));
  const rr6 = Math.max(0, parseInt(document.getElementById('pg-rr-6').value || '0', 10));

  const newRunRule = [];
  if (rr3 > 0) newRunRule.push({ inningComplete: 3, diff: rr3 });
  if (rr4 > 0) newRunRule.push({ inningComplete: 4, diff: rr4 });
  if (rr5 > 0) newRunRule.push({ inningComplete: 5, diff: rr5 });
  if (rr6 > 0) newRunRule.push({ inningComplete: 6, diff: rr6 });

  // 套用到 gameConfig
  gameConfig.maxInnings = pregameSel.innings;
  gameConfig.timeLimitMin = pregameSel.timeMin;
  gameConfig.runRule = newRunRule.length ? newRunRule : []; // 全 0 => 無提前結束條件
  gameConfig.startTs = Date.now();
  gameConfig.gameOver = false;
  gameConfig.endReason = "";
  gameConfig.endReasonPriority = 0;
  gameConfig.timeExpired = false;
  gameConfig.timeExpirePending = null;

  // 依時間制決定是否開計時判斷
  // 若 timeLimitMin=0 => 視為無時間到
  if (gameConfig.timeLimitMin === 0){
    // 讓 timer pill 不警示、且不會觸發 timeExpired
    document.getElementById('pill-timer').classList.remove('warn');
  }

  // 重建 linescore 欄位
  buildLinescore(gameConfig.maxInnings);

  // 在 layer-1 顯示賽制摘要
  renderLayer1ConfigSummary();

  // 初始化 roster（保持你原先 1~9）
  ['上','下'].forEach(s => {
    for (let i=1;i<=9;i++) state.rosters[s][i] = state.rosters[s][i] || { num: i*10, ab:0, hits:0, res:[] };
  });

  // 重新綁定壘包長按（因為 buildLinescore 會重畫 layer-1，但壘包不變；此處安全重做）
  bindBaseLongPress();

  // 關閉賽前選單、顯示比賽畫面
  document.getElementById('pregame-modal').style.display = 'none';
  document.getElementById('game-ui').style.display = 'block';

  // 啟動 timer（你目前是正計時；之後若你要倒數，再一起改）
  startTimerTick();

  // 更新畫面
  updateSettingsUIFromConfig();
  updateUI();
}

function renderLayer1ConfigSummary(){
  const wrap = document.getElementById('linescore-wrap');
  // 若不存在就插入
  let cfg = document.getElementById('layer1-config');
  if (!cfg){
    cfg = document.createElement('div');
    cfg.id = 'layer1-config';
    cfg.className = 'layer1-config';
    wrap.prepend(cfg);
  }

  const timeText = (gameConfig.timeLimitMin === 0) ? '無限制' : `${gameConfig.timeLimitMin}分鐘`;

  const rrText = (gameConfig.runRule && gameConfig.runRule.length)
    ? gameConfig.runRule.map(r => `${r.inningComplete}局差${r.diff}`).join(' / ')
    : '無';

  cfg.innerHTML = `
    <span class="k">局數</span><span class="v"><b>${gameConfig.maxInnings}</b>局</span>
    <span class="k">時間</span><span class="v"><b>${timeText}</b></span>
    <span class="k">提前</span><span class="v"><b>${rrText}</b></span>
  `;
}


    function bindBaseLongPress(){
      document.querySelectorAll('.base[data-base]').forEach(el => {
        el.addEventListener('touchstart', () => beginPress(el), {passive:true});
        el.addEventListener('touchend', endPress, {passive:true});
        el.addEventListener('touchcancel', endPress, {passive:true});
        el.addEventListener('mousedown', () => beginPress(el));
        el.addEventListener('mouseup', endPress);
        el.addEventListener('mouseleave', endPress);
      });
    }

/* =========================
   RUNNER EVENT: STEAL (Integrated)
   - Single: 1->2, 2->3 (success / out)
   - Double:
     (1&2, 3 empty): 1->2 & 2->3  (both safe / lead out / trail out)
     (1&3, 2 empty): 1->2 & 3->H  (both safe / lead out / trail out)
   - Fail => +1 out, DOES NOT advance batterIdx
   - Hide for (2&3) and loaded bases
   - Designed for extension: "趁傳進壘", "失誤進壘"
========================= */

let runnerEventCtx = {
  pressedBase: null,
  action: null,   // 'STEAL' | 'ADVANCE'
  stage: 'root',  // 'root' | 'stealMenu' | 'singleOutcome' | 'doubleOutcome12' | 'doubleOutcome13'
  single: null,   // {from,to}
  doubleMode: null // '12' | '13'
};

function closeRunnerEvent(){
  document.getElementById('runner-event-modal').style.display = 'none';
}

function baseStateText(){
  const occ = [1,2,3].filter(b => state.runners[b]);
  if (!occ.length) return '壘況：無人上壘';
  return `壘況：${occ.join('.')}壘有人`;
}

function makeRunnerBtn(text, bg, onClick){
  const b = document.createElement('button');
  b.className = 'menu-btn';
  b.style.background = bg;
  b.innerText = text;
  b.onclick = onClick;
  return b;
}

function setRunnerEventTitle(text){
  const el = document.getElementById('runner-event-title');
  if (el) el.innerText = text;
}

function renderRunnerEventButtons(btns){
  const box = document.getElementById('runner-event-btns');
  box.innerHTML = '';
  btns.forEach(b => box.appendChild(b));
}

function runnerOcc(){
  return {
    occ1: !!state.runners[1],
    occ2: !!state.runners[2],
    occ3: !!state.runners[3],
  };
}

// 第 0 層：盜壘 / 趁傳
function renderRunnerEventRoot(){
  runnerEventCtx.stage = 'root';
  runnerEventCtx.action = null;
  runnerEventCtx.single = null;
  runnerEventCtx.doubleMode = null;

  setRunnerEventTitle('跑壘事件');
  document.getElementById('runner-event-sub').innerText = baseStateText();

  renderRunnerEventButtons([
    makeRunnerBtn('盜壘', '#2471a3', () => {
      runnerEventCtx.action = 'STEAL';
      renderStealMenu();
    }),
makeRunnerBtn('趁傳', '#8e44ad', () => {
  runnerEventCtx.action = 'ADVANCE';
  renderAdvanceMenu();
}),
  ]);
}

// 第 1 層（盜壘）：依壘況顯示「單盜」或「雙盜壘」
function renderStealMenu(){
  runnerEventCtx.stage = 'stealMenu';
  setRunnerEventTitle('跑壘事件：盜壘');
  document.getElementById('runner-event-sub').innerText = baseStateText();

  const {occ1, occ2, occ3} = runnerOcc();
  const pb = runnerEventCtx.pressedBase;

  // 依你需求：2.3壘有人、滿壘通常不使用盜壘 → 不提供選項（仍可顯示提示）
  if ((occ2 && occ3) || (occ1 && occ2 && occ3)){
    renderRunnerEventButtons([
      makeRunnerBtn('此壘況通常不使用盜壘（已隱藏選項）', '#2b2b2b', () => {}),
      makeRunnerBtn('返回', '#2b2b2b', () => renderRunnerEventRoot())
    ]);
    return;
  }

  const btns = [];

  // 1.2壘有人：按 2壘 → 顯示「盜3壘」+「雙盜壘」
  //           按 1壘 → 只顯示「雙盜壘」（因為 2 壘被佔，單盜 1->2 不成立）
  if (occ1 && occ2 && !occ3){
    if (pb === 2){
      btns.push(makeRunnerBtn('盜 3 壘（2→3）', '#16a085', () => {
        runnerEventCtx.single = {from:2, to:3};
        renderStealSingleOutcome();
      }));
    }
    btns.push(makeRunnerBtn('雙盜壘（1→2、2→3）', '#16a085', () => {
      runnerEventCtx.doubleMode = '12';
      renderStealDoubleOutcome12();
    }));
  }

  // 1.3壘有人且2空：可雙盜 1上2 + 3回本壘得分
  if (occ1 && occ3 && !occ2){
    btns.push(makeRunnerBtn('雙盜壘（1→2、3→Home）', '#16a085', () => {
      runnerEventCtx.doubleMode = '13';
      renderStealDoubleOutcome13();
    }));
  }

  // 單盜：1->2（需 1有人且2空）——按 1壘時最合理
  if (occ1 && !occ2){
    if (pb === 1){
      btns.push(makeRunnerBtn('盜 2 壘（1→2）', '#16a085', () => {
        runnerEventCtx.single = {from:1, to:2};
        renderStealSingleOutcome();
      }));
    } else {
      // 若不是按 1壘，也可以仍提供（視你偏好）；這裡我保守：不按 1壘就不顯示
    }
  }

  // 單盜：2->3（需 2有人且3空）——按 2壘時最合理（含 1.2壘有人已處理）
  if (occ2 && !occ3 && !(occ1 && occ2 && !occ3)){
    if (pb === 2){
      btns.push(makeRunnerBtn('盜 3 壘（2→3）', '#16a085', () => {
        runnerEventCtx.single = {from:2, to:3};
        renderStealSingleOutcome();
      }));
    }
  }

  // 若無任何可用
  if (!btns.length){
    btns.push(makeRunnerBtn('此壘況無可用盜壘選項', '#2b2b2b', () => {}));
  }

  // 返回
  btns.push(makeRunnerBtn('返回', '#2b2b2b', () => renderRunnerEventRoot()));

  renderRunnerEventButtons(btns);
}

// 第 2 層（單盜結果）：成功 / 失敗(+1出局)
function renderStealSingleOutcome(){
  runnerEventCtx.stage = 'singleOutcome';

  const s = runnerEventCtx.single;
  if (!s) { renderStealMenu(); return; }

  const {from, to} = s;

  setRunnerEventTitle(`盜壘結果：${from}→${to}`);
  document.getElementById('runner-event-sub').innerText = baseStateText();

  renderRunnerEventButtons([
    makeRunnerBtn(`成功（SB ${from}→${to}）`, '#16a085', () => {
      applyStealSingle(from, true);
      closeRunnerEvent();
    }),
    makeRunnerBtn(`失敗（CS ${from}→${to}，+1出局）`, '#c0392b', () => {
      applyStealSingle(from, false);
      closeRunnerEvent();
    }),
    makeRunnerBtn('返回', '#2b2b2b', () => renderStealMenu()),
  ]);
}

// 第 2 層（雙盜 1&2 結果）：成功 / 前位出局 / 後位出局
function renderStealDoubleOutcome12(){
  runnerEventCtx.stage = 'doubleOutcome12';
  setRunnerEventTitle('雙盜壘結果：1→2、2→3');
  document.getElementById('runner-event-sub').innerText = baseStateText();

  renderRunnerEventButtons([
    makeRunnerBtn('雙盜壘成功', '#16a085', () => { applyStealDouble12('bothSafe'); closeRunnerEvent(); }),
    makeRunnerBtn('前位出局（2→3出局、1→2成功）', '#e67e22', () => { applyStealDouble12('leadOut'); closeRunnerEvent(); }),
    makeRunnerBtn('後位出局（1→2出局、2→3成功）', '#e67e22', () => { applyStealDouble12('trailOut'); closeRunnerEvent(); }),
    makeRunnerBtn('返回', '#2b2b2b', () => renderStealMenu()),
  ]);
}

// 第 2 層（雙盜 1&3 結果）：成功 / 前位出局 / 後位出局
function renderStealDoubleOutcome13(){
  runnerEventCtx.stage = 'doubleOutcome13';
  setRunnerEventTitle('雙盜壘結果：1→2、3→Home');
  document.getElementById('runner-event-sub').innerText = baseStateText();

  renderRunnerEventButtons([
    makeRunnerBtn('雙盜壘成功', '#16a085', () => { applyStealDouble13('bothSafe'); closeRunnerEvent(); }),
    makeRunnerBtn('前位出局（3→Home 出局、1→2成功）', '#e67e22', () => { applyStealDouble13('leadOut'); closeRunnerEvent(); }),
    makeRunnerBtn('後位出局（1→2出局、3→Home 得分）', '#e67e22', () => { applyStealDouble13('trailOut'); closeRunnerEvent(); }),
    makeRunnerBtn('返回', '#2b2b2b', () => renderStealMenu()),
  ]);
}

// 入口：長按壘包後先進 root（盜壘/趁傳）
function openRunnerEvent(baseNum){
  if (gameConfig.gameOver) return;

  // 長按壘包必須有跑者（維持你原本的規則）
  if (!state.runners[baseNum]){
    showNotice('提示', '該壘無跑者，無法使用跑壘事件。', false);
    return;
  }

  runnerEventCtx.pressedBase = baseNum;
  runnerEventCtx.action = null;
  runnerEventCtx.stage = 'root';
  runnerEventCtx.single = null;
  runnerEventCtx.doubleMode = null;

  renderRunnerEventRoot();
  document.getElementById('runner-event-modal').style.display = 'block';
}



function applyStealSingle(fromBase, success){
  if (gameConfig.gameOver) return;

  const runner = state.runners[fromBase];
  if (!runner){
    showNotice('提示', '來源壘無跑者，無法盜壘。', false);
    return;
  }
  const toBase = fromBase + 1;
  if (toBase > 3){
    showNotice('提示', '此版本未啟用 3壘盜本壘。', false);
    return;
  }
  if (state.runners[toBase]){
    showNotice('提示', '目標壘已有跑者，無法單盜。', false);
    return;
  }

  if (success){
    applyRunnerEvent({
      type: 'STEAL',
      label: `SB ${fromBase}→${toBase}`,
      moves: [{ from: fromBase, to: toBase }],
      outsDelta: 0,
      meta: { mode:'single', result:'safe', runnerNum: runner.num }
    });
  } else {
    applyRunnerEvent({
      type: 'STEAL',
      label: `CS ${fromBase}→${toBase}`,
      moves: [{ from: fromBase, to: null }], // 出局：移除跑者
      outsDelta: 1,
      meta: { mode:'single', result:'out', runnerNum: runner.num }
    });
  }

  closeRunnerEvent();
}

/* ---- Double steal 1&2 (3 empty) ----
   bothSafe: 2->3, 1->2
   leadOut : 2 out, 1->2
   trailOut: 1 out, 2->3
*/
function applyStealDouble12(outcome){
  const occ1 = !!state.runners[1];
  const occ2 = !!state.runners[2];
  const occ3 = !!state.runners[3];
  if (!(occ1 && occ2 && !occ3)){
    showNotice('提示', '雙盜(1&2)僅支援 1、2壘有人且3壘空。', false);
    return;
  }
  const r1 = state.runners[1];
  const r2 = state.runners[2];

  if (outcome === 'bothSafe'){
    applyRunnerEvent({
      type: 'STEAL',
      label: 'DS SB 1→2 & 2→3',
      moves: [{ from: 2, to: 3 }, { from: 1, to: 2 }],
      outsDelta: 0,
      meta: { mode:'double12', result:'bothSafe', runners:[r1.num, r2.num] }
    });
  } else if (outcome === 'leadOut'){
    applyRunnerEvent({
      type: 'STEAL',
      label: 'DS leadOut (2→3 CS), 1→2 SB',
      moves: [{ from: 2, to: null }, { from: 1, to: 2 }],
      outsDelta: 1,
      meta: { mode:'double12', result:'leadOut', leadRunner:r2.num, trailRunner:r1.num }
    });
  } else if (outcome === 'trailOut'){
    applyRunnerEvent({
      type: 'STEAL',
      label: 'DS trailOut (1→2 CS), 2→3 SB',
      moves: [{ from: 1, to: null }, { from: 2, to: 3 }],
      outsDelta: 1,
      meta: { mode:'double12', result:'trailOut', leadRunner:r2.num, trailRunner:r1.num }
    });
  }

  closeRunnerEvent();
}

/* ---- Double steal 1&3 (2 empty) ----
   bothSafe: 3->Home(score), 1->2
   leadOut : 3 out, 1->2
   trailOut: 1 out, 3->Home(score)
*/
function applyStealDouble13(outcome){
  const occ1 = !!state.runners[1];
  const occ2 = !!state.runners[2];
  const occ3 = !!state.runners[3];
  if (!(occ1 && occ3 && !occ2)){
    showNotice('提示', '雙盜(1&3)僅支援 1、3壘有人且2壘空。', false);
    return;
  }
  const r1 = state.runners[1];
  const r3 = state.runners[3];

  if (outcome === 'bothSafe'){
    applyRunnerEvent({
      type: 'STEAL',
      label: 'DS SB 1→2 & 3→H',
      moves: [{ from: 3, to: 4 }, { from: 1, to: 2 }], // to:4 代表得分
      outsDelta: 0,
      meta: { mode:'double13', result:'bothSafe', runners:[r1.num, r3.num] }
    });
  } else if (outcome === 'leadOut'){
    applyRunnerEvent({
      type: 'STEAL',
      label: 'DS leadOut (3→H CS), 1→2 SB',
      moves: [{ from: 3, to: null }, { from: 1, to: 2 }],
      outsDelta: 1,
      meta: { mode:'double13', result:'leadOut', leadRunner:r3.num, trailRunner:r1.num }
    });
  } else if (outcome === 'trailOut'){
    applyRunnerEvent({
      type: 'STEAL',
      label: 'DS trailOut (1→2 CS), 3→H SB',
      moves: [{ from: 1, to: null }, { from: 3, to: 4 }],
      outsDelta: 1,
      meta: { mode:'double13', result:'trailOut', leadRunner:r3.num, trailRunner:r1.num }
    });
  }

  closeRunnerEvent();
}

/* =========================
   RUNNER EVENT: ADVANCE ON THROW (趁傳)
   - Single: 1->2, 2->3, 3->H (safe / out)
   - Double:
     (1&2, 3 empty): 1->2 & 2->3  (both safe / lead out / trail out)
     (1&3, 2 empty): 1->2 & 3->H  (both safe / lead out / trail out)
   - Fail => +1 out, DOES NOT advance batterIdx
   - Conservative handling for (2&3) and loaded:
       allow only single 3->H when pressed base=3 and H available
       otherwise show info (extend later)
========================= */

function renderAdvanceMenu(){
  runnerEventCtx.stage = 'advanceMenu';
  setRunnerEventTitle('跑壘事件：趁傳');
  document.getElementById('runner-event-sub').innerText = baseStateText();

  const {occ1, occ2, occ3} = runnerOcc();
  const pb = runnerEventCtx.pressedBase;

  const btns = [];

  // 2&3 或 滿壘：先保守處理（避免連鎖／衝突）
  // 但允許：長按 3 壘時提供「3→Home 單趁傳」
  const is23 = (occ2 && occ3 && !occ1);
  const isLoaded = (occ1 && occ2 && occ3);

  if (is23 || isLoaded){
    if (pb === 3 && occ3){
      // 3→H 單趁傳（成功/失敗）
      btns.push(makeRunnerBtn('單趁傳：3→Home', '#8e44ad', () => {
        runnerEventCtx.single = {from:3, to:4};
        renderAdvanceSingleOutcome();
      }));
    }

    btns.push(makeRunnerBtn('此壘況趁傳（多跑者）尚未開放其餘選項', '#2b2b2b', () => {}));
    btns.push(makeRunnerBtn('返回', '#2b2b2b', () => renderRunnerEventRoot()));
    renderRunnerEventButtons(btns);
    return;
  }

  // ---------- 單趁傳 ----------
  // 規則：from->to 必須 target 空（3->H 不需要判空，直接視為得分壘）
  if (pb === 1 && occ1 && !occ2){
    btns.push(makeRunnerBtn('單趁傳：1→2', '#8e44ad', () => {
      runnerEventCtx.single = {from:1, to:2};
      renderAdvanceSingleOutcome();
    }));
  }

  if (pb === 2 && occ2 && !occ3){
    btns.push(makeRunnerBtn('單趁傳：2→3', '#8e44ad', () => {
      runnerEventCtx.single = {from:2, to:3};
      renderAdvanceSingleOutcome();
    }));
  }

  if (pb === 3 && occ3){
    // 3→H（得分）
    btns.push(makeRunnerBtn('單趁傳：3→Home', '#8e44ad', () => {
      runnerEventCtx.single = {from:3, to:4};
      renderAdvanceSingleOutcome();
    }));
  }

  // 1.2壘有人：按 2 壘 → 可以單趁傳 2→3 + 雙趁傳
  //            按 1 壘 → 可以雙趁傳（單趁傳1→2不成立，因2被佔）
  if (occ1 && occ2 && !occ3){
    if (pb === 2){
      btns.push(makeRunnerBtn('單趁傳：2→3', '#8e44ad', () => {
        runnerEventCtx.single = {from:2, to:3};
        renderAdvanceSingleOutcome();
      }));
    }
    btns.push(makeRunnerBtn('雙趁傳：1→2、2→3', '#8e44ad', () => {
      runnerEventCtx.doubleMode = '12';
      renderAdvanceDoubleOutcome12();
    }));
  }

  // 1.3壘有人且2空：雙趁傳 1→2、3→H
  if (occ1 && occ3 && !occ2){
    btns.push(makeRunnerBtn('雙趁傳：1→2、3→Home', '#8e44ad', () => {
      runnerEventCtx.doubleMode = '13';
      renderAdvanceDoubleOutcome13();
    }));
  }

  if (!btns.length){
    btns.push(makeRunnerBtn('此壘況無可用趁傳選項', '#2b2b2b', () => {}));
  }

  btns.push(makeRunnerBtn('返回', '#2b2b2b', () => renderRunnerEventRoot()));
  renderRunnerEventButtons(btns);
}

// 第 3 層：單趁傳結果（成功/失敗+1出局）
function renderAdvanceSingleOutcome(){
  runnerEventCtx.stage = 'advanceSingleOutcome';

  const s = runnerEventCtx.single;
  if (!s) { renderAdvanceMenu(); return; }

  const {from, to} = s;

  const toText = (to >= 4) ? 'Home' : String(to);
  setRunnerEventTitle(`趁傳結果：${from}→${toText}`);
  document.getElementById('runner-event-sub').innerText = baseStateText();

  renderRunnerEventButtons([
    makeRunnerBtn(`成功（趁傳 ${from}→${toText}）`, '#16a085', () => {
      applyAdvanceSingle(from, to, true);
      closeRunnerEvent();
    }),
    makeRunnerBtn(`失敗（趁傳出局 +1）`, '#c0392b', () => {
      applyAdvanceSingle(from, to, false);
      closeRunnerEvent();
    }),
    makeRunnerBtn('返回', '#2b2b2b', () => renderAdvanceMenu()),
  ]);
}

// 第 3 層：雙趁傳 1&2 結果
function renderAdvanceDoubleOutcome12(){
  runnerEventCtx.stage = 'advanceDoubleOutcome12';
  setRunnerEventTitle('雙趁傳結果：1→2、2→3');
  document.getElementById('runner-event-sub').innerText = baseStateText();

  renderRunnerEventButtons([
    makeRunnerBtn('雙趁傳成功', '#16a085', () => { applyAdvanceDouble12('bothSafe'); closeRunnerEvent(); }),
    makeRunnerBtn('前位出局（2→3出局、1→2成功）', '#e67e22', () => { applyAdvanceDouble12('leadOut'); closeRunnerEvent(); }),
    makeRunnerBtn('後位出局（1→2出局、2→3成功）', '#e67e22', () => { applyAdvanceDouble12('trailOut'); closeRunnerEvent(); }),
    makeRunnerBtn('返回', '#2b2b2b', () => renderAdvanceMenu()),
  ]);
}

// 第 3 層：雙趁傳 1&3 結果
function renderAdvanceDoubleOutcome13(){
  runnerEventCtx.stage = 'advanceDoubleOutcome13';
  setRunnerEventTitle('雙趁傳結果：1→2、3→Home');
  document.getElementById('runner-event-sub').innerText = baseStateText();

  renderRunnerEventButtons([
    makeRunnerBtn('雙趁傳成功', '#16a085', () => { applyAdvanceDouble13('bothSafe'); closeRunnerEvent(); }),
    makeRunnerBtn('前位出局（3→Home 出局、1→2成功）', '#e67e22', () => { applyAdvanceDouble13('leadOut'); closeRunnerEvent(); }),
    makeRunnerBtn('後位出局（1→2出局、3→Home 得分）', '#e67e22', () => { applyAdvanceDouble13('trailOut'); closeRunnerEvent(); }),
    makeRunnerBtn('返回', '#2b2b2b', () => renderAdvanceMenu()),
  ]);
}

/* ---- Apply: Single advance on throw ---- */
function applyAdvanceSingle(fromBase, toBase, success){
  if (gameConfig.gameOver) return;

  const runner = state.runners[fromBase];
  if (!runner){
    showNotice('提示', '來源壘無跑者，無法趁傳。', false);
    return;
  }

  // 目的壘判斷：toBase 2/3 必須空；toBase 4 視為 Home 得分
  if (toBase < 4 && state.runners[toBase]){
    showNotice('提示', '目標壘已有跑者，無法單趁傳。', false);
    return;
  }

  if (success){
    applyRunnerEvent({
      type: 'ADVANCE',
      label: (toBase >= 4) ? `趁傳 ${fromBase}→H` : `趁傳 ${fromBase}→${toBase}`,
      moves: [{ from: fromBase, to: toBase }], // to:4 代表得分
      outsDelta: 0,
      meta: { mode:'single', result:'safe', cause:'onThrow', runnerNum: runner.num }
    });
  } else {
    applyRunnerEvent({
      type: 'ADVANCE',
      label: (toBase >= 4) ? `趁傳出局 ${fromBase}→H` : `趁傳出局 ${fromBase}→${toBase}`,
      moves: [{ from: fromBase, to: null }], // 出局移除
      outsDelta: 1,
      meta: { mode:'single', result:'out', cause:'onThrow', runnerNum: runner.num }
    });
  }
}

/* ---- Apply: Double advance 1&2 (3 empty) ---- */
function applyAdvanceDouble12(outcome){
  const occ1 = !!state.runners[1];
  const occ2 = !!state.runners[2];
  const occ3 = !!state.runners[3];
  if (!(occ1 && occ2 && !occ3)){
    showNotice('提示', '雙趁傳(1&2)僅支援 1、2壘有人且3壘空。', false);
    return;
  }
  const r1 = state.runners[1];
  const r2 = state.runners[2];

  if (outcome === 'bothSafe'){
    applyRunnerEvent({
      type: 'ADVANCE',
      label: '雙趁傳 成功：1→2、2→3',
      moves: [{ from: 2, to: 3 }, { from: 1, to: 2 }],
      outsDelta: 0,
      meta: { mode:'double12', result:'bothSafe', cause:'onThrow', runners:[r1.num, r2.num] }
    });
  } else if (outcome === 'leadOut'){
    applyRunnerEvent({
      type: 'ADVANCE',
      label: '雙趁傳 前位出局：2出局、1→2',
      moves: [{ from: 2, to: null }, { from: 1, to: 2 }],
      outsDelta: 1,
      meta: { mode:'double12', result:'leadOut', cause:'onThrow', leadRunner:r2.num, trailRunner:r1.num }
    });
  } else if (outcome === 'trailOut'){
    applyRunnerEvent({
      type: 'ADVANCE',
      label: '雙趁傳 後位出局：1出局、2→3',
      moves: [{ from: 1, to: null }, { from: 2, to: 3 }],
      outsDelta: 1,
      meta: { mode:'double12', result:'trailOut', cause:'onThrow', leadRunner:r2.num, trailRunner:r1.num }
    });
  }
}

/* ---- Apply: Double advance 1&3 (2 empty) ---- */
function applyAdvanceDouble13(outcome){
  const occ1 = !!state.runners[1];
  const occ2 = !!state.runners[2];
  const occ3 = !!state.runners[3];
  if (!(occ1 && occ3 && !occ2)){
    showNotice('提示', '雙趁傳(1&3)僅支援 1、3壘有人且2壘空。', false);
    return;
  }
  const r1 = state.runners[1];
  const r3 = state.runners[3];

  if (outcome === 'bothSafe'){
    applyRunnerEvent({
      type: 'ADVANCE',
      label: '雙趁傳 成功：1→2、3→H',
      moves: [{ from: 3, to: 4 }, { from: 1, to: 2 }],
      outsDelta: 0,
      meta: { mode:'double13', result:'bothSafe', cause:'onThrow', runners:[r1.num, r3.num] }
    });
  } else if (outcome === 'leadOut'){
    applyRunnerEvent({
      type: 'ADVANCE',
      label: '雙趁傳 前位出局：3出局、1→2',
      moves: [{ from: 3, to: null }, { from: 1, to: 2 }],
      outsDelta: 1,
      meta: { mode:'double13', result:'leadOut', cause:'onThrow', leadRunner:r3.num, trailRunner:r1.num }
    });
  } else if (outcome === 'trailOut'){
    applyRunnerEvent({
      type: 'ADVANCE',
      label: '雙趁傳 後位出局：1出局、3→H',
      moves: [{ from: 1, to: null }, { from: 3, to: 4 }],
      outsDelta: 1,
      meta: { mode:'double13', result:'trailOut', cause:'onThrow', leadRunner:r3.num, trailRunner:r1.num }
    });
  }
}


/* ---- Generic runner event engine (extensible) ----
   moves: [{from:1,to:2},{from:3,to:4},{from:2,to:null}]
   outsDelta: 0/1/2...
*/
function applyRunnerEvent(ev){
  if (gameConfig.gameOver) return;

  saveHist();

  // 先把 from 清空，避免覆蓋
  const newR = { ...state.runners };
  const fromBases = ev.moves.map(m => m.from).filter(b => b !== null && b !== undefined);
  fromBases.forEach(b => { newR[b] = null; });

  // 套用 moves（呼叫者已用「大壘先」順序給 moves）
  for (const m of ev.moves){
    if (m.to === null){
      // 出局：不放回壘上
      continue;
    }
    if (m.to >= 4){
      // 得分（Home）
      scoreRun(1);
      continue;
    }
    if (newR[m.to]){
      // 防覆蓋：取消並回復
      showNotice('提示', `目標壘 ${m.to} 已有跑者，事件取消（避免覆蓋）。`, false);
      undo();
      return;
    }
    const runnerObj = state.runners[m.from];
    newR[m.to] = runnerObj;
  }

  state.runners = newR;

  // 出局（不推進打者）
  if (ev.outsDelta > 0){
    addRunnerOut(ev.outsDelta);
  }

  // 記錄事件：獨立於打擊結果
  recordPlayEvent({
    type: 'runner',
    label: ev.label,
    loc: null,
    meta: { ...(ev.meta || {}), runnerEvent: true }
  });

  updateUI();

  // 若跑回本壘得分可能觸發再見/提前結束
  checkWalkoff();
  checkMercyRule();
}

/* ---- Runner out: only increments outs; DOES NOT advance batterIdx ---- */
function addRunnerOut(n){
  state.O += n;

  if (state.O >= 3){
    const nextSide = state.side === '上' ? '下' : '上';
    showNotice(
      "攻守交換",
      `由 <b>${nextSide==='上'?'客隊':'主隊'}</b><br>第 <b>${state.batterIdx[nextSide]}</b> 棒開始打擊`,
      true
    );
  }
}


    function beginPress(el){
      if (gameConfig.gameOver) return;
      pressedBase = parseInt(el.dataset.base, 10);
      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => openRunnerEvent(pressedBase), 420);
    }
    function endPress(){ clearTimeout(pressTimer); pressTimer = null; }

    function openBaseEdit(baseNum){
      const runner = state.runners[baseNum];
      document.getElementById('base-edit-sub').innerText = `壘包：${baseNum}壘（${runner?('#'+runner.num):'無跑者'}）`;
      document.getElementById('base-edit-modal').style.display = 'block';
      refreshBaseEditImportButtons(baseNum);
    }
    function closeBaseEdit(){ document.getElementById('base-edit-modal').style.display = 'none'; }

    function refreshBaseEditImportButtons(targetBase){
      const srcs = [1,2,3].filter(b => b !== targetBase && state.runners[b]);
      const sec = document.getElementById('base-edit-import-section');
      const box = document.getElementById('base-edit-import-btns');
      box.innerHTML = '';
      if (!srcs.length){ sec.style.display = 'none'; return; }
      sec.style.display = 'block';
      srcs.forEach(b => {
        const r = state.runners[b];
        const btn = document.createElement('button');
        btn.className = 'menu-btn';
        btn.style.background = '#2c3e50';
        btn.innerText = `${b}壘 #${r.num} → ${targetBase}壘`;
        btn.onclick = () => {
          saveHist();
          state.runners[targetBase] = r;
          state.runners[b] = null;
          recordPlayEvent({type:'special', label:`BASEMOVE ${b}->${targetBase}`, loc:null, meta:{manualBaseEdit:true, from:b, to:targetBase, runnerNum:r.num}});
          closeBaseEdit();
          updateUI();
        };
        box.appendChild(btn);
      });
    }




    function renderPoints(){
      const layer = document.getElementById('points-layer');
      layer.innerHTML = '';
      state.points.forEach(p => {
        if (p.side !== state.side) return;
        const el = document.createElement('div');
        const cls = (p.type==='hit'?'H':(p.type==='out'?'O':(p.type==='foul'?'F':'E')));
        el.className = `hit-point point-${cls}`;
        el.style.left = p.x + '%';
        el.style.top = p.y + '%';
        el.innerText = String(p.label).split('(')[0];
        layer.appendChild(el);
      });
    }

    function updateUI(){
      document.getElementById('disp-inning').innerText = `${state.inning}${state.side}`;

      document.getElementById('dots-B').innerHTML = "●".repeat(state.B).fontcolor("#f39c12") + "○".repeat(3-state.B).fontcolor("#444");
      document.getElementById('dots-S').innerHTML = "●".repeat(state.S).fontcolor("#2ecc71") + "○".repeat(2-state.S).fontcolor("#444");
      document.getElementById('dots-O').innerHTML = "●".repeat(state.O).fontcolor("#e74c3c") + "○".repeat(2-state.O).fontcolor("#444");

      for (let i=1;i<=gameConfig.maxInnings;i++){
        const a = document.getElementById(`as-${i}`);
        const h = document.getElementById(`hs-${i}`);
        if (a) a.innerText = (state.awayScore[i-1] ?? 0);
        if (h){
          if (i === gameConfig.maxInnings && state.homeX && state.side === '下') h.innerText = 'x';
          else h.innerText = (state.homeScore[i-1] ?? 0);
        }
      }

      document.getElementById('away-R').innerText = totalRuns('上');
      document.getElementById('home-R').innerText = totalRuns('下');
      document.getElementById('away-H').innerText = state.awayH;
      document.getElementById('home-H').innerText = state.homeH;
      document.getElementById('away-E').innerText = state.awayE;
      document.getElementById('home-E').innerText = state.homeE;

      for (let i=1;i<=3;i++){
        const b = document.getElementById(`base-${i}`);
        const tag = document.getElementById(`rtag-${i}`);
        if (state.runners[i]){
          b.classList.add('occupied');
          tag.innerText = `#${state.runners[i].num}`;
          tag.style.display = 'block';
        } else {
          b.classList.remove('occupied');
          tag.style.display = 'none';
        }
      }

      const side = state.side;
      const bIdx = state.batterIdx[side];
      const nIdx = (bIdx % 9) + 1;

const curr = state.rosters[side][bIdx];

// 本壘上方顯示：目前打者 背號/姓名
const batterTag = document.getElementById('batter-tag');
if (batterTag && curr){
  const numText = curr.num != null ? `#${curr.num}` : '';
  const nameText = (curr.name && String(curr.name).trim()) ? ` ${String(curr.name).trim()}` : '';
  batterTag.innerText = `${numText}${nameText}`.trim() || '打者';
};
      const next = state.rosters[side][nIdx];

      document.getElementById('b-main').innerText = `第${bIdx}棒 #${curr.num}`;
      document.getElementById('b-stats').innerHTML = `AVG: ${(curr.hits/(curr.ab||1)).toFixed(3)}<br>${curr.res.slice(-2).join(', ') || '--'}`;
      document.getElementById('n-main').innerText = `第${nIdx}棒 #${next.num}`;
      document.getElementById('n-stats').innerHTML = `AVG: ${(next.hits/(next.ab||1)).toFixed(3)}<br>${next.res.slice(-2).join(', ') || '--'}`;

      document.getElementById('p-pitches').innerText = `P: ${state.pPitches[defendingSide()]}`;
// 投手標籤：顯示目前守備方（defendingSide）的投手
const def = defendingSide();
const p = (state.pitchers && state.pitchers[def]) ? state.pitchers[def] : { num:'--', name:'投手' };
document.getElementById('pitcher-tag').innerText = `#${p.num} ${p.name || ''}`.trim();
      document.getElementById('pill-format').innerText = `賽制：${gameConfig.maxInnings}局 / ${gameConfig.timeLimitMin}分鐘`;
      document.getElementById('pill-runrule').innerText = `提前結束：4局10分 / 5局7分`;

      renderPoints();

      if (gameConfig.gameOver || gameConfig.timeExpired || state.homeX){
        document.getElementById('end-game-btn').style.display = 'inline-block';
      }
    }
  </script>
</body>
</html>
