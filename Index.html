

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>專業棒球紀錄器 v4.7.3</title>
  <style>
    html, body { position: fixed; overflow: hidden; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; background: #1a1a1a; color: white; margin: 0; }
    * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    .layer-1 { width: 100%; background: #222; overflow-x: auto; border-bottom: 1px solid #444; }
    .linescore { width: 100%; border-collapse: collapse; font-size: 10px; text-align: center; table-layout: fixed; min-width: 360px; }
    .linescore td { border: 1px solid #333; padding: 6px 0; height: 35px; }
    .s-cell { font-weight: 800; color: #f1c40f; }

    .layer-2 { display: flex; background: #111; padding: 10px 5px; border-bottom: 1px solid #444; height: 100px; }
    .info-column { flex: 1; padding: 0 5px; border-left: 1px solid #333; display: flex; flex-direction: column; justify-content: center; }
    .info-main { font-size: 13px; font-weight: 800; }
    .info-sub { font-size: 10px; color: #aaa; margin-top: 3px; line-height: 1.3; }

    .layer-3 { display: flex; justify-content: space-around; align-items: center; background: #222; padding: 8px 5px; border-bottom: 1px solid #444; }
    .stat-item { font-size: 14px; font-weight: 900; cursor: pointer; user-select:none; }
    .dots { margin-left: 5px; letter-spacing: 2px; font-size: 16px; }
    .undo-text { font-size: 20px; color: #888; padding-left: 10px; border-left: 1px solid #444; }

    .layer-4 { position: relative; width: 100vw; max-width: 520px; aspect-ratio: 1 / 1; background: #222; margin: auto; overflow: hidden; }
    .field-bg { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 1; transform: scale(1.1); transform-origin: center 75%; }

    .diamond-overlay { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
    .base { position: absolute; width: 22px; height: 22px; background: rgba(90,90,90,0.95); border: 1.5px solid #777; transition: 0.2s; z-index: 10; pointer-events: auto; }
    #base-1 { top: 70%; left: 75%; transform: translate(-50%, -50%) rotate(45deg); }
    #base-2 { top: 42.5%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); }
    #base-3 { top: 70%; left: 25%; transform: translate(-50%, -50%) rotate(45deg); }
    #base-home { top: 95%; left: 50%; transform: translateX(-50%); width: 28px; height: 28px; background: #666; clip-path: polygon(0% 0%, 100% 0%, 100% 50%, 50% 100%, 0% 50%); border:none; pointer-events:none; }

    .base.occupied { background: #f1c40f; border-color: #fff; box-shadow: 0 0 12px #f1c40f; }
    .runner-tag { position: absolute; background: #000; color: #f1c40f; padding: 2px 4px; border-radius: 4px; font-size: 11px; font-weight: 900; border: 1.5px solid #f1c40f; white-space: nowrap; z-index: 20; transform: rotate(-45deg); top: -25px; left: -5px; display: none; }

    #points-layer { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
    .hit-point { position: absolute; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 900; color: white; transform: translate(-50%, -50%); border: 1px solid rgba(255,255,255,0.4); }
    .point-H { background: #3498db; } .point-O { background: #e74c3c; } .point-F { background: #f39c12; } .point-E { background: #9b59b6; }
    .click-capture { position: absolute; inset: 0; z-index: 4; cursor: crosshair; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 1000; }
    .notice-content { background: white; color: #333; padding: 20px; border-radius: 15px; text-align: center; max-width: 420px; margin: 40px auto; }
    .sheet { position: absolute; left: 0; right: 0; bottom: 0; background: #111; color: white; border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 12px 12px 16px; box-shadow: 0 -10px 30px rgba(0,0,0,0.4); max-height: 82vh; overflow: auto; animation: slideUp 160ms ease-out; }
    @keyframes slideUp { from { transform: translateY(24px); opacity: 0.7; } to { transform: translateY(0); opacity: 1; } }
    .sheet-handle { width: 44px; height: 4px; background: #333; border-radius: 99px; margin: 0 auto 10px; }
    .sheet-title { display:flex; align-items:center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .sheet-title h3 { margin: 0; font-size: 14px; color: #f1c40f; }
    .sheet-sub { font-size: 11px; color:#aaa; }

    .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .menu-btn { width: 100%; padding: 14px 10px; border: none; border-radius: 10px; font-weight: 900; color: white; font-size: 16px; cursor: pointer; user-select:none; }
    .menu-btn.secondary { background:#2b2b2b; color:#ddd; font-weight: 800; }
    .menu-btn:active, .meta-btn:active, .def-btn:active, .mini-btn:active { transform: scale(0.99); }

    .mini-row { display:flex; gap: 8px; margin-top: 10px; }
    .mini-btn { flex: 1; padding: 10px 8px; border-radius: 10px; border: 1px solid #333; background: #1c1c1c; color: #ddd; font-weight: 900; font-size: 12px; cursor: pointer; }
    .mini-btn.active { border-color: #f1c40f; color: #111; background: #f1c40f; }

    .section { margin-top: 12px; padding-top: 12px; border-top: 1px solid #222; }
    .section-title { display:flex; align-items:center; justify-content: space-between; font-size: 12px; color:#bbb; margin-bottom: 8px; }

    .def-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .def-btn { padding: 12px 8px; border-radius: 10px; border: 1px solid #333; background: #1c1c1c; color: #ddd; font-weight: 900; cursor: pointer; user-select:none; }
    .def-btn.suggest { border-color: #e67e22; box-shadow: 0 0 0 1px rgba(230,126,34,0.25) inset; }
    .def-btn.active { background: #e67e22; border-color: #e67e22; color: #111; }

    .primary-cta { margin-top: 10px; display:flex; gap: 8px; }
    .primary-cta .menu-btn { font-size: 15px; padding: 12px 10px; border-radius: 12px; }

    .choice-pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: #1b1b1b; border: 1px solid #2c2c2c; color: #ddd; font-size: 12px; }

    .meta-bar { display:flex; align-items:center; justify-content: space-between; padding: 6px 10px; border-bottom: 1px solid #333; background:#151515; font-size: 11px; color:#bbb; gap: 10px; }
    .meta-left { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid #2c2c2c; background:#101010; color:#ddd; font-weight: 900; }
    .pill.warn { border-color:#c0392b; color:#fff; background:#c0392b; }
    .meta-btn { padding: 6px 10px; border-radius: 10px; border: 1px solid #333; background:#1c1c1c; color:#ddd; font-weight: 900; cursor:pointer; user-select:none; white-space: nowrap; }
    .meta-btn.danger { background:#c0392b; border-color:#c0392b; color:#fff; }

    .radio-row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .radio-pill { display:flex; align-items:center; gap: 6px; border: 1px solid #333; background:#1c1c1c; color:#ddd; padding: 8px 10px; border-radius: 999px; font-weight: 900; font-size: 12px; cursor: pointer; user-select:none; }
    .radio-pill.active { background:#f1c40f; color:#111; border-color:#f1c40f; }
  </style>
</head>
<body>
  <div id="notice-modal" class="modal">
    <div class="notice-content">
      <h2 id="notice-title" style="color:#e67e22; margin:0 0 8px;">提示</h2>
      <p id="notice-body" style="margin:0 0 12px;"></p>
      <button id="notice-btn" class="menu-btn secondary" onclick="closeNoticeModal()">確定</button>
    </div>
  </div>

  <div id="game-ui">
    <div class="meta-bar">
      <div class="meta-left">
        <span class="pill" id="pill-format">賽制：7局 / 120分鐘</span>
        <span class="pill" id="pill-timer">用時：00:00 / 120</span>
        <span class="pill" id="pill-runrule">提前結束：4局10分 / 5局7分</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="meta-btn" onclick="openSettings()">賽制設定</button>
        <button class="meta-btn danger" id="end-game-btn" onclick="showEndGameNotice()" style="display:none;">比賽結束</button>
      </div>
    </div>

    <div class="layer-1" id="linescore-wrap"></div>

    <div class="layer-2">
      <div class="info-column">
        <div style="font-size:9px;color:#888;">PITCHER</div>
        <div class="info-main">#11 守方</div>
        <div class="info-sub" id="p-pitches" style="color:#f1c40f">P: 0</div>
      </div>
      <div class="info-column">
        <div style="font-size:9px;color:#888;">BATTER</div>
        <div class="info-main" id="b-main">第1棒 #10</div>
        <div class="info-sub" id="b-stats">AVG: .000<br>--</div>
      </div>
      <div class="info-column">
        <div style="font-size:9px;color:#888;">NEXT</div>
        <div class="info-main" id="n-main">第2棒 #20</div>
        <div class="info-sub" id="n-stats">AVG: .000<br>--</div>
      </div>
    </div>

    <div class="layer-3">
      <div class="stat-item" style="color:#f1c40f" id="disp-inning">1上</div>
      <div class="stat-item" id="btn-ball" onclick="handleBall()">
  B <span class="dots" id="dots-B"></span>
</div>
      <div class="stat-item" onclick="handleStrike()">S <span class="dots" id="dots-S"></span></div>
      <div class="stat-item">O <span class="dots" id="dots-O"></span></div>
		<div class="stat-item" style="color:#9b59b6;" onclick="openSpecial()">特</div>
      <div class="stat-item undo-text" onclick="undo()">↺</div>
    </div>

    <div class="layer-4">
      <svg class="field-bg" viewBox="0 0 100 100">
        <rect width="100" height="100" fill="#a67c52" />
        <path d="M 50 95 L -20 25 A 100 100 0 0 1 120 25 L 50 95" fill="#2d5a27" />
        <path d="M 15 85 L 15 60 A 38 38 0 0 1 85 60 L 85 85 L 50 95 Z" fill="#a67c52" />
        <path d="M 50 95 L 25 70 L 50 45 L 75 70 Z" fill="#2d5a27" stroke="white" stroke-width="0.3" />
        <line x1="50" y1="95" x2="-20" y2="25" stroke="white" stroke-width="0.8" />
        <line x1="50" y1="95" x2="120" y2="25" stroke="white" stroke-width="0.8" />
      </svg>

      <div id="points-layer"></div>

      <div class="diamond-overlay">
        <div id="base-home" class="base"></div>
        <div id="base-1" class="base" data-base="1"><div id="rtag-1" class="runner-tag"></div></div>
        <div id="base-2" class="base" data-base="2"><div id="rtag-2" class="runner-tag"></div></div>
        <div id="base-3" class="base" data-base="3"><div id="rtag-3" class="runner-tag"></div></div>
      </div>

      <div class="click-capture" onclick="handleMapClick(event)"></div>
    </div>
  </div>

  <!-- 合併 modal：界內 -->
  <div id="fair-sheet-modal" class="modal" onclick="backdropClose(event, 'fair-sheet-modal')">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheet-handle"></div>

      <div class="sheet-title">
        <div>
          <h3>擊球結果（界內）</h3>
          <div class="sheet-sub" id="fair-loc-text">落點：x=50 y=80</div>
        </div>
        <div class="choice-pill" id="fair-choice-pill">尚未選擇</div>
      </div>

      <div class="btn-row">
        <button class="menu-btn" style="background:#3498db;" onclick="pickPlayNeedingFielder('1H', 1, 'hit')">一壘安打</button>
        <button class="menu-btn" style="background:#2980b9;" onclick="pickPlayNeedingFielder('2H', 2, 'hit')">二壘安打</button>
        <button class="menu-btn" style="background:#2471a3;" onclick="pickPlayNeedingFielder('3H', 3, 'hit')">三壘安打</button>
        <button class="menu-btn" style="background:#c0392b;" onclick="execPlay('HR', 4, 'hit', {recordPoint:true, countPitch:true, saveHist:true})">全壘打</button>

        <button class="menu-btn" style="background:#e74c3c;" onclick="pickPlayNeedingFielder('O', 0, 'out')">出局</button>
        <button class="menu-btn" style="background:#9b59b6;" onclick="openErrorBasesChooser()">失誤（E）</button>
      </div>

      <div class="section" id="error-bases-section" style="display:none;">
        <div class="section-title">
          <span>失誤進壘（E1/E2/E3）</span>
          <span style="color:#666;font-size:11px;">（選擇打者最終到達壘包）</span>
        </div>
        <div class="btn-row">
          <button class="menu-btn" style="background:#8e44ad;" onclick="pickPlayNeedingFielder('E1', 1, 'error')">E1（上一壘）</button>
          <button class="menu-btn" style="background:#8e44ad;" onclick="pickPlayNeedingFielder('E2', 2, 'error')">E2（上二壘）</button>
          <button class="menu-btn" style="background:#8e44ad;" onclick="pickPlayNeedingFielder('E3', 3, 'error')">E3（上三壘）</button>
          <button class="menu-btn secondary" onclick="hideErrorBasesChooser()">取消</button>
        </div>
      </div>

      <div class="section" id="fair-detail-section" style="display:none;">
        <div class="section-title">
          <span>擊球型態</span>
          <span style="color:#666;font-size:11px;">（可不選）</span>
        </div>

        <div class="mini-row">
          <button class="mini-btn" id="suffix-gb" onclick="setSuffixUI('滾地')">滾地</button>
          <button class="mini-btn" id="suffix-ld" onclick="setSuffixUI('平飛')">平飛</button>
          <button class="mini-btn" id="suffix-fb" onclick="setSuffixUI('高飛')">高飛</button>
        </div>

        <div class="section-title" style="margin-top:12px;">
          <span>守備處理球員</span>
          <span style="color:#666;font-size:11px;">（建議者已高亮）</span>
        </div>

        <div id="def-grid" class="def-grid"></div>

        <div class="primary-cta">
          <button class="menu-btn" style="background:#e67e22;" onclick="confirmCombinedPlay()">確定紀錄</button>
          <button class="menu-btn secondary" onclick="closeMenus()">取消</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>其他</span>
          <span style="color:#666;font-size:11px;">（不需守備）</span>
        </div>
        <div class="btn-row">
          <button class="menu-btn secondary" onclick="closeMenus()">關閉</button>
          <button class="menu-btn secondary" onclick="showNotice('提示', '保送請用 B 鍵（四球自動 BB）。', false)">保送說明</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 界外 -->
  <div id="foul-menu" class="modal" onclick="backdropClose(event, 'foul-menu')">
    <div class="notice-content" onclick="event.stopPropagation()">
      <h3 style="margin-top:0;">界外區域</h3>
      <button class="menu-btn" style="background:#f39c12;" onclick="execPlay('F', 0, 'foul', {recordPoint:true, countPitch:false, saveHist:true})">界外球</button>
      <button class="menu-btn" style="background:#e74c3c;"
        onclick="execPlay('FO', 0, 'out', {recordPoint:true, countPitch:false, saveHist:true, metaExtra:{isFoulOut:true}})">
        界外接殺
      </button>
      <button class="menu-btn secondary" style="margin-top:10px;" onclick="closeMenus()">取消</button>
    </div>
  </div>

<!-- 特殊跑壘 -->

<div id="special-modal" class="modal" onclick="backdropClose(event,'special-modal')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>

    <div class="sheet-title">
      <h3>特殊跑壘</h3>
      <div class="sheet-sub">僅影響跑者與出局數</div>
    </div>

<div class="btn-row">
  <button class="menu-btn" style="background:#16a085;" onclick="doSB()">盜壘（SB）</button>
  <button class="menu-btn" style="background:#8e44ad;" onclick="doBK()">投手犯規（BK）</button>
  <button class="menu-btn" style="background:#d35400;" onclick="doDroppedK()">不死三振（K+WP）</button>
  <button class="menu-btn" style="background:#2ecc71;" onclick="doHBP()">觸身（HBP）</button>

  <button class="menu-btn" style="background:#34495e;" onclick="openFC()">野手選擇（FC）</button>
  <button class="menu-btn" style="background:#c0392b;" onclick="openDP()">雙殺（DP）</button>
</div>

<!-- 盜壘：企圖/結果（同一個 sheet 內切換） -->
<div class="section" id="steal-section" style="display:none;">
  <div class="section-title">
    <span id="steal-step-title">盜壘企圖</span>
    <span style="color:#666;font-size:11px;" id="steal-step-sub">請先選擇企圖</span>
  </div>

  <!-- Step 1: 企圖選擇 -->
  <div id="steal-step-attempt">
    <div class="btn-row" id="steal-options"></div>
  </div>

  <!-- Step 2: 結果選擇 -->
  <div id="steal-step-result" style="display:none;">
    <div class="btn-row" id="steal-results"></div>

    <div class="mini-row" style="margin-top:10px;">
      <button class="mini-btn" onclick="backToStealAttempt()">← 回到企圖選擇</button>
      <button class="mini-btn" onclick="cancelStealFlow()">取消盜壘</button>
    </div>
  </div>
</div>



    <div class="section">
      <button class="menu-btn secondary" onclick="closeSpecial()">關閉</button>
    </div>
  </div>
</div>


<!-- FC -->
<div class="section" id="fc-section" style="display:none;">
  <div class="section-title">
    <span>野手選擇（FC）</span>
    <span style="color:#666;font-size:11px;">（選擇抓哪一壘跑者）</span>
  </div>
  <div class="btn-row" id="fc-options"></div>
</div>

<!-- DP -->
<div class="section" id="dp-section" style="display:none;">
  <div class="section-title">
    <span>雙殺（DP）</span>
    <span style="color:#666;font-size:11px;">（最小版：選型態）</span>
  </div>
  <div class="btn-row" id="dp-options"></div>
</div>



  <!-- 賽制設定 -->
  <div id="settings-modal" class="modal" onclick="backdropClose(event, 'settings-modal')">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheet-handle"></div>
      <div class="sheet-title">
        <div>
          <h3>賽制設定</h3>
          <div class="sheet-sub">時間到處置（120分鐘）</div>
        </div>
        <div class="choice-pill" id="settings-pill">已套用</div>
      </div>

      <div class="section" style="margin-top:0; padding-top:0; border-top:none;">
        <div class="section-title">
          <span>時間到處置</span>
          <span style="color:#666;font-size:11px;">（三選一/手動）</span>
        </div>

        <div class="radio-row">
          <div class="radio-pill" id="pol-immediate" onclick="setTimePolicyUI('immediate')">立即結束</div>
          <div class="radio-pill" id="pol-half" onclick="setTimePolicyUI('endHalf')">完成半局</div>
          <div class="radio-pill" id="pol-inning" onclick="setTimePolicyUI('endInning')">完成該局</div>
          <div class="radio-pill" id="pol-manual" onclick="setTimePolicyUI('manual')">顯示按鈕手動</div>
        </div>

        <div style="margin-top:10px; font-size:12px; color:#aaa; line-height:1.5;">
          • 立即結束：時間到立刻結束並停表。<br>
          • 完成半局：時間到後，等下一次「攻守交換」才結束。<br>
          • 完成該局：時間到後，等該局下半打完才結束。<br>
          • 顯示按鈕手動：時間到顯示「比賽結束」按鈕，由你決定何時結束。
        </div>

        <div class="primary-cta">
          <button class="menu-btn" style="background:#16a085;" onclick="applySettings()">套用設定</button>
          <button class="menu-btn secondary" onclick="closeSettings()">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 壘包修正 -->
  <div id="base-edit-modal" class="modal" onclick="backdropClose(event, 'base-edit-modal')">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheet-handle"></div>
      <div class="sheet-title">
        <div>
          <h3>壘包修正</h3>
          <div class="sheet-sub" id="base-edit-sub">壘包：-</div>
        </div>
        <div class="choice-pill">修正跑者目前位置（不可倒退，需倒退請用 ↺）</div>
      </div>

      <div class="section" style="margin-top:0; padding-top:0; border-top:none;">
        <div class="section-title">
          <span>此壘跑者</span>
          <span style="color:#666;font-size:11px;">清除／移動／得分</span>
        </div>

        <div class="btn-row">
          <button class="menu-btn" style="background:#7f8c8d;" onclick="baseEditClear()">清除此壘跑者</button>
          <button class="menu-btn" style="background:#c0392b;" onclick="baseEditScore()">跑者回本壘得分</button>
        </div>

        <div class="section-title" style="margin-top:12px;">
          <span>移動到</span>
          <span style="color:#666;font-size:11px;">不影響出局數</span>
        </div>
    </button>

    <button class="menu-btn" style="background:#8e44ad;"
      onclick="baseEditAdvanceByPitch('PB')">
      捕逸（PB）
    </button>
  </div>
</div>

        <div class="btn-row">
          <button class="menu-btn" style="background:#34495e;" onclick="baseEditMoveTo(1)">移到一壘</button>
          <button class="menu-btn" style="background:#34495e;" onclick="baseEditMoveTo(2)">移到二壘</button>
          <button class="menu-btn" style="background:#34495e;" onclick="baseEditMoveTo(3)">移到三壘</button>
          <button class="menu-btn secondary" onclick="closeBaseEdit()">關閉</button>
        </div>

        <div class="section" id="base-edit-import-section" style="display:none;">
          <div class="section-title">
            <span>從其他壘移入此壘</span>
            <span style="color:#666;font-size:11px;">（修正站錯壘）</span>
          </div>
          <div class="btn-row" id="base-edit-import-btns"></div>
        </div>
      </div>
    </div>
  </div>


<div id="ball-extra-modal" class="modal" onclick="backdropClose(event,'ball-extra-modal')">
  <div class="notice-content" onclick="event.stopPropagation()">
    <h3 style="margin-top:0;">壞球特殊狀況</h3>
    <button class="menu-btn" style="background:#e67e22;" onclick="doPitchAdvance('WP')">暴投（WP）</button>
    <button class="menu-btn" style="background:#8e44ad;" onclick="doPitchAdvance('PB')">捕逸（PB）</button>
    <button class="menu-btn secondary" style="margin-top:10px;" onclick="closeBallExtra()">取消</button>
  </div>
</div>

  <script>
    const END_PRI = { manual: 10, inningEnd: 20, homeX: 30, time: 40, mercy: 50, walkoff: 60 };

    let gameConfig = {
      mode: 'innings',
      maxInnings: 7,
      timeLimitMin: 120,
      startTs: Date.now(),
      gameOver: false,
      endReason: "",
      endReasonPriority: 0,
      timeExpired: false,
      timeExpiredPolicy: 'manual',
      timeExpirePending: null,
      runRule: [
        { inningComplete: 4, diff: 10 },
        { inningComplete: 5, diff: 7 }
      ]
    };

    let state = {
      inning: 1, side: '上',
      B: 0, S: 0, O: 0,
      awayScore: Array(9).fill(0),
      homeScore: Array(9).fill(0),
      awayH: 0, homeH: 0,
      awayE: 0, homeE: 0,
      pPitches: { '上': 0, '下': 0 },
      runners: { 1: null, 2: null, 3: null },
      batterIdx: { '上': 1, '下': 1 },
      rosters: { '上': {}, '下': {} },
      points: [],
      homeX: false
    };

    // v4.6.8: plays[]（保留；本版本已移除匯入/匯出）
    let plays = [];
    let playSeq = 1;

    let history = [];
    let lastLoc = { x: 50, y: 80 };
    let lastLocValid = false;

    let pendingPlay = null;
	 let pendingSteal = null; // { label, moves:[{from,to}...], isDouble:boolean }
    let currentSuffix = "";
    let selectedFielder = "";
    let lastSuffixMemory = "";

    let timerTick = null;

    let pressTimer = null;
    let pressedBase = null;

    let tmpTimePolicy = null;

    (function init() {
      ['上','下'].forEach(s => {
        for (let i=1;i<=9;i++) state.rosters[s][i] = { num: i*10, ab:0, hits:0, res:[] };
      });
      buildLinescore(gameConfig.maxInnings);
      bindBaseLongPress();
      
updateSettingsUIFromConfig();
      updateUI();
      startTimerTick();
    })();

    function buildLinescore(nInnings) {
      const wrap = document.getElementById('linescore-wrap');
      const cols = [];
      for (let i=1;i<=nInnings;i++) cols.push(i);

      const headerInnings = cols.map(i => `<td>${i}</td>`).join('');
      const awayCells = cols.map(i => `<td class="s-cell" id="as-${i}">-</td>`).join('');
      const homeCells = cols.map(i => `<td class="s-cell" id="hs-${i}">-</td>`).join('');

      wrap.innerHTML = `
        <table class="linescore">
          <tr>
            <td style="color:#f1c40f; width:60px;">客</td>
            ${headerInnings}
            <td style="background:#2d2d2d;width:25px;">R</td>
            <td style="width:25px;">H</td>
            <td style="width:25px;">E</td>
          </tr>
          <tr id="away-data-row">
            <td>客隊</td>
            ${awayCells}
            <td id="away-R">0</td>
            <td id="away-H">0</td>
            <td id="away-E">0</td>
          </tr>
          <tr id="home-data-row">
            <td>主隊</td>
            ${homeCells}
            <td id="home-R">0</td>
            <td id="home-H">0</td>
            <td id="home-E">0</td>
          </tr>
        </table>
      `;
    }

    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

    function totalRuns(side){
      const arr = side==='上' ? state.awayScore : state.homeScore;
      return arr.reduce((a,b)=>a+b,0);
    }
    function scoreDiffAbs(){ return Math.abs(totalRuns('上') - totalRuns('下')); }
    function fmtTime(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    }
    function defendingSide(){ return state.side==='上' ? '下' : '上'; }

    function showNotice(title, body, isSwap=false) {
      document.getElementById('notice-title').innerText = title;
      document.getElementById('notice-body').innerHTML = body;
      const btn = document.getElementById('notice-btn');
      btn.dataset.swap = isSwap ? "true" : "false";
      btn.onclick = closeNoticeModal;
      document.getElementById('notice-modal').style.display = 'block';
    }
    function closeNoticeModal() {
      const btn = document.getElementById('notice-btn');
      const isSwap = btn.dataset.swap === "true";
      document.getElementById('notice-modal').style.display = 'none';
      if (isSwap) swapSides('3outs');
      updateUI();
    }

    function openSettings(){
      tmpTimePolicy = gameConfig.timeExpiredPolicy;
      updateTimePolicyPills(tmpTimePolicy);
      document.getElementById('settings-modal').style.display = 'block';
    }
    function closeSettings(){ document.getElementById('settings-modal').style.display = 'none'; }
    function setTimePolicyUI(pol){ tmpTimePolicy = pol; updateTimePolicyPills(pol); }
    function updateTimePolicyPills(pol){
      ['pol-immediate','pol-half','pol-inning','pol-manual'].forEach(id => document.getElementById(id).classList.remove('active'));
      if (pol==='immediate') document.getElementById('pol-immediate').classList.add('active');
      if (pol==='endHalf') document.getElementById('pol-half').classList.add('active');
      if (pol==='endInning') document.getElementById('pol-inning').classList.add('active');
      if (pol==='manual') document.getElementById('pol-manual').classList.add('active');
    }
    function applySettings(){
      saveHist();
      gameConfig.timeExpiredPolicy = tmpTimePolicy || 'manual';
      updateSettingsUIFromConfig();
      closeSettings();
      updateUI();
    }
    function updateSettingsUIFromConfig(){
      const map = { immediate:'立即結束', endHalf:'完成半局', endInning:'完成該局', manual:'顯示按鈕手動' };
      document.getElementById('settings-pill').innerText = map[gameConfig.timeExpiredPolicy] || '已套用';
      updateTimePolicyPills(gameConfig.timeExpiredPolicy);
    }

    function startTimerTick(){
      if (timerTick) clearInterval(timerTick);
      timerTick = setInterval(() => {
        if (gameConfig.gameOver) return;
        const elapsed = Date.now() - gameConfig.startTs;
        const limitMs = gameConfig.timeLimitMin * 60 * 1000;

        document.getElementById('pill-timer').innerText = `用時：${fmtTime(elapsed)} / ${gameConfig.timeLimitMin}`;

        if (!gameConfig.timeExpired && elapsed >= limitMs){
          gameConfig.timeExpired = true;
          const pillTimer = document.getElementById('pill-timer');
          pillTimer.classList.add('warn');

          if (gameConfig.timeExpiredPolicy === 'immediate'){
            setEndReason('時間到（立即結束）', END_PRI.time);
            finalizeGame();
          } else if (gameConfig.timeExpiredPolicy === 'endHalf'){
            gameConfig.timeExpirePending = 'half';
            setEndReason('時間到（完成半局後結束）', END_PRI.time);
            showEndGameButton(true, END_PRI.time);
          } else if (gameConfig.timeExpiredPolicy === 'endInning'){
            gameConfig.timeExpirePending = 'inning';
            setEndReason('時間到（完成該局後結束）', END_PRI.time);
            showEndGameButton(true, END_PRI.time);
          } else {
            setEndReason('時間到（手動結束）', END_PRI.time);
            showEndGameButton(true, END_PRI.time);
          }
        }
      }, 250);
    }
    function stopTimerTick(){
      if (timerTick) clearInterval(timerTick);
      timerTick = null;
    }

    function setEndReason(reason, priority){
      if (priority >= (gameConfig.endReasonPriority || 0)){
        gameConfig.endReason = reason;
        gameConfig.endReasonPriority = priority;
      }
    }
    function showEndGameButton(show, priority){
      const btn = document.getElementById('end-game-btn');
      if (!show){ btn.style.display='none'; return; }
      if (priority >= (gameConfig.endReasonPriority || 0)) btn.style.display='inline-block';
      else if (btn.style.display==='none') btn.style.display='inline-block';
    }

    function showEndGameNotice(){
      const a = totalRuns('上');
      const h = totalRuns('下');
      const reason = gameConfig.endReason || '手動結束';
      showNotice('比賽結束', `原因：<b>${reason}</b><br>比數：<b>${a}</b> - <b>${h}</b><br>（按確定即結束並停表）`, false);
      const btn = document.getElementById('notice-btn');
      btn.onclick = () => { document.getElementById('notice-modal').style.display='none'; setEndReason(reason, END_PRI.manual); finalizeGame(); };
    }

    function finalizeGame(){
      gameConfig.gameOver = true;
      stopTimerTick();
      document.getElementById('end-game-btn').style.display = 'inline-block';
      const a = totalRuns('上');
      const h = totalRuns('下');
      showNotice('比賽已結束', `原因：<b>${gameConfig.endReason || '（未指定）'}</b><br>比數：<b>${a}</b> - <b>${h}</b>`, false);
    }

    function handleBall(){
      if (gameConfig.gameOver) return;
      saveHist();
      state.B++;
      state.pPitches[defendingSide()]++;
      recordPlayEvent({ type:'pitch', label:'B', loc:null, meta:{} });

      if (state.B >= 4){
        execPlay('BB', 1, 'special', {recordPoint:false, countPitch:false, saveHist:false});
      } else updateUI();
    }

    function handleStrike(){
      if (gameConfig.gameOver) return;
      saveHist();
      state.S++;
      state.pPitches[defendingSide()]++;
      recordPlayEvent({ type:'pitch', label:'S', loc:null, meta:{} });

      if (state.S >= 3){
        execPlay('K', 0, 'out', {recordPoint:false, countPitch:false, saveHist:false});
      } else updateUI();
    }

    function handleMapClick(e){
      if (gameConfig.gameOver) return;
      const rect = document.querySelector('.layer-4').getBoundingClientRect();
      lastLoc = {
        x: ((e.clientX - rect.left) / rect.width) * 100,
        y: ((e.clientY - rect.top) / rect.height) * 100
      };
      lastLocValid = true;

      document.getElementById('fair-loc-text').innerText = `落點：x=${lastLoc.x.toFixed(1)} y=${lastLoc.y.toFixed(1)}`;

      let dx = lastLoc.x - 50;
      let dy = 95 - lastLoc.y;
      const inFair = dy >= Math.abs(dx) * 1.0 && lastLoc.y <= 95;

      if (inFair){
        resetFairSheet();
        document.getElementById('fair-sheet-modal').style.display = 'block';
      } else {
        document.getElementById('foul-menu').style.display = 'block';
      }
    }

    function backdropClose(e, id){
      if (e.target.id === id) closeMenus();
    }
    function closeMenus(){
      document.getElementById('fair-sheet-modal').style.display = 'none';
      document.getElementById('foul-menu').style.display = 'none';
      document.getElementById('settings-modal').style.display = 'none';
      document.getElementById('base-edit-modal').style.display = 'none';

document.getElementById('special-modal').style.display = 'none';

      pendingPlay = null;
      currentSuffix = "";
      selectedFielder = "";
      hideErrorBasesChooser();

document.getElementById('fair-detail-section').style.display = 'none';
    }

    function resetFairSheet(){
      pendingPlay = null;
      selectedFielder = "";
      currentSuffix = lastSuffixMemory || "";
      setSuffixUI(currentSuffix, true);
      document.getElementById('fair-choice-pill').innerText = '尚未選擇';
      hideErrorBasesChooser();
      document.getElementById('fair-detail-section').style.display = 'none';
      document.getElementById('def-grid').innerHTML = '';
    }

    function openErrorBasesChooser(){
      document.getElementById('error-bases-section').style.display = 'block';
      document.getElementById('fair-detail-section').style.display = 'none';
    }
    function hideErrorBasesChooser(){
      const sec = document.getElementById('error-bases-section');
      if (sec) sec.style.display = 'none';
    }

    function pickPlayNeedingFielder(label, bases, type){
      pendingPlay = { label, bases, type };
      document.getElementById('fair-choice-pill').innerText = label;
      document.getElementById('fair-detail-section').style.display = 'block';
      hideErrorBasesChooser();
      buildFielderButtons();
    }

    function setSuffixUI(s, init=false){
      currentSuffix = s || "";
      if (!init) lastSuffixMemory = currentSuffix;
      ['suffix-gb','suffix-ld','suffix-fb'].forEach(id => document.getElementById(id).classList.remove('active'));
      if (currentSuffix === '滾地') document.getElementById('suffix-gb').classList.add('active');
      if (currentSuffix === '平飛') document.getElementById('suffix-ld').classList.add('active');
      if (currentSuffix === '高飛') document.getElementById('suffix-fb').classList.add('active');
    }

    function getSuggestedFielders(x, y){
      let suggest = [];
      if (y > 75) suggest = ["C", "P"];
      else if (y > 45){
        if (x < 35) suggest = ["3B", "SS"];
        else if (x > 65) suggest = ["1B", "2B"];
        else suggest = ["P", "2B", "SS"];
      } else {
        if (x < 33) suggest = ["LF", "CF"];
        else if (x > 66) suggest = ["RF", "CF"];
        else suggest = ["CF", "LF", "RF"];
      }
      return suggest;
    }

    function buildFielderButtons(){
      const grid = document.getElementById('def-grid');
      grid.innerHTML = '';
      const all = ["P","C","1B","2B","3B","SS","LF","CF","RF"];
      const suggests = lastLocValid ? getSuggestedFielders(lastLoc.x, lastLoc.y) : ["P","SS","CF"];
      all.forEach(pos => {
        const btn = document.createElement('button');
        btn.className = 'def-btn';
        if (suggests.includes(pos)) btn.classList.add('suggest');
        btn.innerText = pos;
        btn.onclick = () => {
          selectedFielder = pos;
          [...grid.children].forEach(el => el.classList.remove('active'));
          btn.classList.add('active');
        };
        grid.appendChild(btn);
      });
      if (suggests.length){
        const first = suggests[0];
        const idx = all.indexOf(first);
        if (idx >= 0){
          selectedFielder = first;
          grid.children[idx].classList.add('active');
        }
      }
    }

    function confirmCombinedPlay(){
      if (!pendingPlay) return;
      if (!selectedFielder) { showNotice('提示', '請先選擇守備處理球員', false); return; }
      const suffix = currentSuffix || "";
      const finalLabel = suffix ? `${pendingPlay.label}(${suffix}${selectedFielder})` : `${pendingPlay.label}(${selectedFielder})`;
      execPlay(finalLabel, pendingPlay.bases, pendingPlay.type, {recordPoint:true, countPitch:true, saveHist:true});
      closeMenus();
    }

    function snapshotForPlay(){
      return {
        inning: state.inning,
        side: state.side,
        B: state.B, S: state.S, O: state.O,
        runners: deepClone(state.runners),
        awayR: totalRuns('上'),
        homeR: totalRuns('下'),
        awayH: state.awayH,
        homeH: state.homeH,
        awayE: state.awayE,
        homeE: state.homeE,
        batterIdx: deepClone(state.batterIdx),
      };
    }
    function currentBatterInfo(){
      const side = state.side;
      const idx = state.batterIdx[side];
      const b = state.rosters[side][idx];
      return { side, idx, num: b?.num ?? null };
    }
    function recordPlayEvent(ev, beforeSnap=null){
      const before = beforeSnap || snapshotForPlay();
      const batter = currentBatterInfo();
      const after = snapshotForPlay();
      plays.push({
        seq: playSeq++,
        ts: Date.now(),
        type: ev.type,
        label: ev.label,
        inning: before.inning,
        side: before.side,
        batter,
        before,
        after,
        loc: ev.loc || null,
        meta: ev.meta || {}
      });
      if (ev.type === 'play' || ev.type === 'foul') checkWalkoff();
    }
    function recordSwapEvent(reason){
      const snap = snapshotForPlay();
      plays.push({
        seq: playSeq++,
        ts: Date.now(),
        type: "swap",
        label: "SWAP",
        inning: snap.inning,
        side: snap.side,
        batter: currentBatterInfo(),
        before: snap,
        after: snap,
        loc: null,
        meta: {
          reason: reason || "swap",
          endedInning: snap.inning,
          endedSide: snap.side,
          score: { away: snap.awayR, home: snap.homeR }
        }
      });
    }

    function scoreRun(n){
      const arr = state.side === '上' ? state.awayScore : state.homeScore;
      const i = state.inning - 1;
      arr[i] = (arr[i] || 0) + n;
    }

    function placeRunnerWithForce(nR, targetBase, runnerObj, scoreCb){
      let b = targetBase;
      let cur = runnerObj;
      while (b <= 3){
        if (!nR[b]) { nR[b] = cur; return; }
        const occupant = nR[b];
        nR[b] = cur;
        cur = occupant;
        b += 1;
      }
      scoreCb(1);
    }

function handleWalkLike(label){
  const side = state.side;
  const batter = state.rosters[side][state.batterIdx[side]];
  const nR = { ...state.runners };
  let sc = 0;

  // 從三壘往回處理「被迫」
  if (nR[3] && nR[2] && nR[1]) {
    // 滿壘 → 三壘得分
    sc++;
    nR[3] = nR[2];
    nR[2] = nR[1];
    nR[1] = batter;
  } else {
    // 1、2 壘都有人 → 2→3，1→2
    if (nR[2] && nR[1]) {
      nR[3] = nR[2];
      nR[2] = nR[1];
      nR[1] = batter;
    }
    // 只有 1 壘有人 → 1→2
    else if (nR[1]) {
      nR[2] = nR[1];
      nR[1] = batter;
    }
    // 1 壘空 → 打者上一壘，2 壘不推進
    else {
      nR[1] = batter;
    }
  }

  state.runners = nR;
  if (sc > 0) scoreRun(sc);

  // 記錄結果（不算 AB）
  batter.res.push(label);

  // 重置球數
  state.B = 0;
  state.S = 0;

  // 推進棒次
  state.batterIdx[side] = (state.batterIdx[side] % 9) + 1;

  updateUI();
}


    function execPlay(label, bases, type, opts={}){
      if (gameConfig.gameOver) return;

if (label === 'BB' || label === 'HBP') {
  saveHist();

  const beforeSnap = snapshotForPlay();
  handleWalkLike(label);

  recordPlayEvent({
    type: 'play',
    label,
    loc: null,
    meta: { walkLike: true }
  }, beforeSnap);

  return;
}



      const recordPoint = opts.recordPoint ?? false;
      const countPitch  = opts.countPitch ?? false;
      const saveHistFlag = opts.saveHist ?? false;
      const metaExtra = opts.metaExtra || {};

      if (saveHistFlag) saveHist();
      if (countPitch) state.pPitches[defendingSide()]++;

      if (recordPoint && lastLocValid){
        state.points.push({ ...lastLoc, label, type, side: state.side });
      }

      const side = state.side;
      const batter = state.rosters[side][state.batterIdx[side]];
      const beforeSnap = snapshotForPlay();

      if (type === 'hit' || type === 'error' || type === 'special'){
        if (type === 'hit'){
          batter.hits++;
          if (side==='上') state.awayH++; else state.homeH++;
        }
        if (type === 'error'){
          // 記 E：這裡用「攻方造成守方失誤」顯示在守方 E 欄位
          if (side==='上') state.homeE++; else state.awayE++;
        }
        if (label !== 'BB') batter.ab++;
        batter.res.push(label);

        let sc = 0;
        const nR = {1:null,2:null,3:null};

        for (let i=3;i>=1;i--){
          if (!state.runners[i]) continue;
          const target = i + bases;
          if (target >= 4) sc++;
          else nR[target] = state.runners[i];
        }

        if (bases >= 4){
          sc++;
        } else if (bases > 0){
          placeRunnerWithForce(nR, bases, batter, (n)=> sc+=n);
        }

        state.runners = nR;
        if (sc>0) scoreRun(sc);

        state.batterIdx[side] = (state.batterIdx[side] % 9) + 1;

      } else if (type === 'out'){
        batter.ab++;
        batter.res.push(label);
        addOut();

      } else if (type === 'foul'){
        if (state.S < 2) state.S++;
      }

      recordPlayEvent({
        type: (type==='foul' ? 'foul' : 'play'),
        label,
        loc: recordPoint && lastLocValid ? {x:lastLoc.x, y:lastLoc.y} : null,
        meta: metaExtra
      }, beforeSnap);

      if (type !== 'foul'){ state.B = 0; state.S = 0; }

      updateUI();
    }

function addOut(){
  state.O++;

  // 先決定：這個出局打者結束後，下一棒是誰
  const nextIdx = (state.batterIdx[state.side] % 9) + 1;

  if (state.O >= 3){
    // 第三出局：半局結束，但「下一半局」應該從 nextIdx 開始
    // 所以把目前攻方的 batterIdx 直接推到 nextIdx，讓下次他們上來時能正確接續
    state.batterIdx[state.side] = nextIdx;

    const nextSide = state.side === '上' ? '下' : '上';
    showNotice(
      "攻守交換",
      `由 <b>${nextSide==='上'?'客隊':'主隊'}</b><br>第 <b>${state.batterIdx[nextSide]}</b> 棒開始打擊`,
      true
    );
  } else {
    // 非第三出局：下一位打者上來
    state.batterIdx[state.side] = nextIdx;
  }
}

    function swapSides(reason){
      recordSwapEvent(reason);
      state.O = 0; state.B = 0; state.S = 0;
      state.runners = {1:null,2:null,3:null};

      // 末局上半結束若主隊領先 → 直接結束（X）
      if (state.side === '上'){
        if (state.inning === gameConfig.maxInnings && totalRuns('下') > totalRuns('上')){
          state.homeX = true;
          setEndReason('末局上半主隊領先（X）', END_PRI.homeX);
          showEndGameButton(true, END_PRI.homeX);
          finalizeGame();
          return;
        }
        state.side = '下';
      } else {
        state.side = '上';
        state.inning++;
        if (state.inning > gameConfig.maxInnings){
          setEndReason('局數到', END_PRI.inningEnd);
          finalizeGame();
          return;
        }
      }

      // 時間到 pending
      if (gameConfig.timeExpired && gameConfig.timeExpirePending){
        if (gameConfig.timeExpirePending === 'half'){
          finalizeGame(); return;
        }
        if (gameConfig.timeExpirePending === 'inning'){
          // 若剛完成下半（進入下一局上半）→ 結束
          if (state.side === '上'){ finalizeGame(); return; }
        }
      }

      checkMercyRule();
      updateUI();
    }

    function checkMercyRule(){
      const completed = state.inning - 1;
      const diff = scoreDiffAbs();
      for (const rr of gameConfig.runRule){
        if (completed >= rr.inningComplete && diff >= rr.diff){
          setEndReason(`提前結束（${rr.inningComplete}局差${rr.diff}分）`, END_PRI.mercy);
          showEndGameButton(true, END_PRI.mercy);
          finalizeGame();
          return;
        }
      }
    }

    function checkWalkoff(){
      // 末局下半超前 → 再見分
      if (state.side === '下' && state.inning === gameConfig.maxInnings){
        if (totalRuns('下') > totalRuns('上')){
          setEndReason('再見分', END_PRI.walkoff);
          showEndGameButton(true, END_PRI.walkoff);
          finalizeGame();
          return true;
        }
      }
      return false;
    }

    function saveHist(){
      history.push(JSON.stringify({ state, gameConfig, plays, playSeq, lastLoc, lastLocValid, lastSuffixMemory }));
      if (history.length > 200) history.shift();
    }
    function undo(){
      if (!history.length) return;
      const prev = JSON.parse(history.pop());
      state = prev.state;
      gameConfig = prev.gameConfig;
      plays = prev.plays;
      playSeq = prev.playSeq;
      lastLoc = prev.lastLoc;
      lastLocValid = prev.lastLocValid;
      lastSuffixMemory = prev.lastSuffixMemory || "";

      if (gameConfig.gameOver) stopTimerTick(); else startTimerTick();
      updateSettingsUIFromConfig();
      updateUI();
    }

    function bindBaseLongPress(){
      document.querySelectorAll('.base[data-base]').forEach(el => {
        el.addEventListener('touchstart', () => beginPress(el), {passive:true});
        el.addEventListener('touchend', endPress, {passive:true});
        el.addEventListener('touchcancel', endPress, {passive:true});
        el.addEventListener('mousedown', () => beginPress(el));
        el.addEventListener('mouseup', endPress);
        el.addEventListener('mouseleave', endPress);
      });
    }
    function beginPress(el){
      if (gameConfig.gameOver) return;
      pressedBase = parseInt(el.dataset.base, 10);
      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => openBaseEdit(pressedBase), 420);
    }
    function endPress(){ clearTimeout(pressTimer); pressTimer = null; }

    function openBaseEdit(baseNum){
      const runner = state.runners[baseNum];
      document.getElementById('base-edit-sub').innerText = `壘包：${baseNum}壘（${runner?('#'+runner.num):'無跑者'}）`;
      document.getElementById('base-edit-modal').style.display = 'block';
      refreshBaseEditImportButtons(baseNum);
    }
    function closeBaseEdit(){ document.getElementById('base-edit-modal').style.display = 'none'; }

function bindBallLongPress(){
  const btn = document.getElementById('btn-ball');
  if (!btn) return;

  let timer = null;

  btn.addEventListener('touchstart', () => {
    timer = setTimeout(openBallExtraMenu, 420);
  }, { passive:true });

  btn.addEventListener('touchend', () => clearTimeout(timer), { passive:true });
  btn.addEventListener('touchcancel', () => clearTimeout(timer), { passive:true });

  btn.addEventListener('mousedown', () => {
    timer = setTimeout(openBallExtraMenu, 420);
  });

  btn.addEventListener('mouseup', () => clearTimeout(timer));
  btn.addEventListener('mouseleave', () => clearTimeout(timer));
}

    function refreshBaseEditImportButtons(targetBase){
      const srcs = [1,2,3].filter(b => b !== targetBase && state.runners[b]);
      const sec = document.getElementById('base-edit-import-section');
      const box = document.getElementById('base-edit-import-btns');
      box.innerHTML = '';
      if (!srcs.length){ sec.style.display = 'none'; return; }
      sec.style.display = 'block';
      srcs.forEach(b => {
        const r = state.runners[b];
        const btn = document.createElement('button');
        btn.className = 'menu-btn';
        btn.style.background = '#2c3e50';
        btn.innerText = `${b}壘 #${r.num} → ${targetBase}壘`;
        btn.onclick = () => {
          saveHist();
          state.runners[targetBase] = r;
          state.runners[b] = null;
          recordPlayEvent({type:'special', label:`BASEMOVE ${b}->${targetBase}`, loc:null, meta:{manualBaseEdit:true, from:b, to:targetBase, runnerNum:r.num}});
          closeBaseEdit();
          updateUI();
        };
        box.appendChild(btn);
      });
    }

    function baseEditClear(){
      const baseNum = pressedBase;
      if (!baseNum) return;
      if (!state.runners[baseNum]) { closeBaseEdit(); return; }
      saveHist();
      const r = state.runners[baseNum];
      state.runners[baseNum] = null;
      recordPlayEvent({type:'special', label:`BASECLEAR ${baseNum}`, loc:null, meta:{manualBaseEdit:true, action:'clear', base:baseNum, runnerNum:r.num}});
      closeBaseEdit();
      updateUI();
    }

    function baseEditScore(){
      const baseNum = pressedBase;
      if (!baseNum) return;
      if (!state.runners[baseNum]) { closeBaseEdit(); return; }
      saveHist();
      const r = state.runners[baseNum];
      state.runners[baseNum] = null;
      scoreRun(1);
      recordPlayEvent({type:'special', label:`MANUAL RUN +1`, loc:null, meta:{manualBaseEdit:true, action:'score', fromBase:baseNum, runnerNum:r.num}});
      closeBaseEdit();
      updateUI();
      checkWalkoff();
    }

    function baseEditMoveTo(toBase){
  const fromBase = pressedBase;
  if (!fromBase) return;
  if (!state.runners[fromBase]) { closeBaseEdit(); return; }

  // =====【新增：禁止倒退】=====
  if (toBase < fromBase){
    showNotice(
      '無法倒退',
      '壘包修正僅允許前進，請使用 ↺ 回復紀錄'
    );
    return;
  }
  // =====【新增結束】=====

  saveHist();

  const r = state.runners[fromBase];
  state.runners[fromBase] = null;

  // 正常前進（你原本的行為）
  const t = state.runners[toBase];
  state.runners[toBase] = r;

  // 若目標壘已有跑者，交換（你原本的設計）
  if (t) state.runners[fromBase] = t;

  recordPlayEvent({
    type:'special',
    label:`BASEMOVE ${fromBase}->${toBase}`,
    loc:null,
    meta:{
      manualBaseEdit:true,
      action:'move',
      from:fromBase,
      to:toBase,
      runnerNum:r.num
    }
  });

  closeBaseEdit();
  updateUI();
}

function baseEditAdvanceByPitch(kind){
  saveHist();

  let scored = 0;

  // === 1. 投球：壞球 + 投手球數 ===
  state.B++;
  state.pPitches[defendingSide()]++;

  // === 2. 所有壘上跑者一起前進一壘（由後往前）===
  for (let b = 3; b >= 1; b--){
    const r = state.runners[b];
    if (!r) continue;

    state.runners[b] = null;

    if (b === 3){
      scored++;
    } else {
      state.runners[b + 1] = r;
    }
  }

  if (scored > 0) scoreRun(scored);

  // === 3. 記錄事件（一次事件）===
  recordPlayEvent({
    type: 'special',
    label: kind,
    loc: null,
    meta: {
      pitchAdvance: true,
      kind,
      runnersAdvanced: true
    }
  });

  // === 4. 若剛好四壞 → 自動保送 ===
  if (state.B >= 4){
    execPlay('BB', 1, 'special', {
      recordPoint:false,
      countPitch:false,
      saveHist:false
    });
    closeBaseEdit();
    return;
  }

  closeBaseEdit();
  updateUI();
}


    function renderPoints(){
      const layer = document.getElementById('points-layer');
      layer.innerHTML = '';
      state.points.forEach(p => {
        if (p.side !== state.side) return;
        const el = document.createElement('div');
        const cls = (p.type==='hit'?'H':(p.type==='out'?'O':(p.type==='foul'?'F':'E')));
        el.className = `hit-point point-${cls}`;
        el.style.left = p.x + '%';
        el.style.top = p.y + '%';
        el.innerText = String(p.label).split('(')[0];
        layer.appendChild(el);
      });
    }

    function updateUI(){
      document.getElementById('disp-inning').innerText = `${state.inning}${state.side}`;

      document.getElementById('dots-B').innerHTML = "●".repeat(state.B).fontcolor("#f39c12") + "○".repeat(3-state.B).fontcolor("#444");
      document.getElementById('dots-S').innerHTML = "●".repeat(state.S).fontcolor("#2ecc71") + "○".repeat(2-state.S).fontcolor("#444");
      document.getElementById('dots-O').innerHTML = "●".repeat(state.O).fontcolor("#e74c3c") + "○".repeat(2-state.O).fontcolor("#444");

      for (let i=1;i<=gameConfig.maxInnings;i++){
        const a = document.getElementById(`as-${i}`);
        const h = document.getElementById(`hs-${i}`);
        if (a) a.innerText = (state.awayScore[i-1] ?? 0);
        if (h){
          if (i === gameConfig.maxInnings && state.homeX && state.side === '下') h.innerText = 'x';
          else h.innerText = (state.homeScore[i-1] ?? 0);
        }
      }

      document.getElementById('away-R').innerText = totalRuns('上');
      document.getElementById('home-R').innerText = totalRuns('下');
      document.getElementById('away-H').innerText = state.awayH;
      document.getElementById('home-H').innerText = state.homeH;
      document.getElementById('away-E').innerText = state.awayE;
      document.getElementById('home-E').innerText = state.homeE;

      for (let i=1;i<=3;i++){
        const b = document.getElementById(`base-${i}`);
        const tag = document.getElementById(`rtag-${i}`);
        if (state.runners[i]){
          b.classList.add('occupied');
          tag.innerText = `#${state.runners[i].num}`;
          tag.style.display = 'block';
        } else {
          b.classList.remove('occupied');
          tag.style.display = 'none';
        }
      }

      const side = state.side;
      const bIdx = state.batterIdx[side];
      const nIdx = (bIdx % 9) + 1;
      const curr = state.rosters[side][bIdx];
      const next = state.rosters[side][nIdx];

      document.getElementById('b-main').innerText = `第${bIdx}棒 #${curr.num}`;
      document.getElementById('b-stats').innerHTML = `AVG: ${(curr.hits/(curr.ab||1)).toFixed(3)}<br>${curr.res.slice(-2).join(', ') || '--'}`;
      document.getElementById('n-main').innerText = `第${nIdx}棒 #${next.num}`;
      document.getElementById('n-stats').innerHTML = `AVG: ${(next.hits/(next.ab||1)).toFixed(3)}<br>${next.res.slice(-2).join(', ') || '--'}`;

      document.getElementById('p-pitches').innerText = `P: ${state.pPitches[defendingSide()]}`;

      document.getElementById('pill-format').innerText = `賽制：${gameConfig.maxInnings}局 / ${gameConfig.timeLimitMin}分鐘`;
      document.getElementById('pill-runrule').innerText = `提前結束：4局10分 / 5局7分`;

      renderPoints();

      if (gameConfig.gameOver || gameConfig.timeExpired || state.homeX){
        document.getElementById('end-game-btn').style.display = 'inline-block';
      }
    }


/* ===== Special Runner Events (SB / CS) ===== */

function openSpecial(){
  if (gameConfig.gameOver) return;
  document.getElementById('special-modal').style.display = 'block';
}
function closeSpecial(){
  document.getElementById('special-modal').style.display = 'none';
  pendingSteal = null;
  const sec = document.getElementById('steal-section');
  if (sec) sec.style.display = 'none';
}

function resetSpecialSheets(){
  const ids = ['steal-section','fc-section','dp-section'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
}

function openFC(){
  if (gameConfig.gameOver) return;
  resetSpecialSheets();

  const opts = getFCOptions();
  if (!opts.length){
    showNotice('提示','目前沒有適用 FC 的壘況（至少要有壘上跑者）');
    return;
  }

  document.getElementById('fc-section').style.display = 'block';
  const box = document.getElementById('fc-options');
  box.innerHTML = '';

  opts.forEach(o => {
    const btn = document.createElement('button');
    btn.className = 'menu-btn';
    btn.style.background = '#34495e';
    btn.innerText = o.label;
    btn.onclick = () => commitFC(o);
    box.appendChild(btn);
  });
}

function openDP(){
  if (gameConfig.gameOver) return;
  resetSpecialSheets();

  const opts = getDPOptions();
  if (!opts.length){
    showNotice('提示','目前沒有適用 DP 的壘況（需要至少一位跑者 + 可能的封殺/傳殺）');
    return;
  }

  document.getElementById('dp-section').style.display = 'block';
  const box = document.getElementById('dp-options');
  box.innerHTML = '';

  opts.forEach(o => {
    const btn = document.createElement('button');
    btn.className = 'menu-btn';
    btn.style.background = '#c0392b';
    btn.innerText = o.label;
    btn.onclick = () => commitDP(o);
    box.appendChild(btn);
  });
}

function openStealChooser(){
  // 比賽已結束不可操作
  if (gameConfig.gameOver) return;

  // 關閉其他特殊事件區塊（FC / DP 等）
  resetSpecialSheets();

  // 依目前壘況取得可用盜壘選項
  const opts = getStealOptions();

  // 沒有任何可盜壘選項
  if (!opts.length){
    showNotice('提示', '目前沒有可盜壘的跑者');
    return;
  }

  // 顯示盜壘區塊（Step 1：企圖）
  const sec = document.getElementById('steal-section');
  sec.style.display = 'block';

  document.getElementById('steal-step-attempt').style.display = 'block';
  document.getElementById('steal-step-result').style.display = 'none';

  document.getElementById('steal-step-title').innerText = '盜壘企圖';
  document.getElementById('steal-step-sub').innerText = '請選擇企圖';

  // 產生企圖按鈕
  const box = document.getElementById('steal-options');
  box.innerHTML = '';

  opts.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'menu-btn';
    btn.style.background = '#16a085';
    btn.innerText = opt.label;
    btn.onclick = () => chooseStealAttempt(opt);
    box.appendChild(btn);
  });
}

function chooseStealAttempt(opt){
  pendingSteal = {
    label: opt.label,
    moves: opt.moves || [],
    isDouble: (opt.moves || []).length >= 2
  };

  document.getElementById('steal-step-attempt').style.display = 'none';
  document.getElementById('steal-step-result').style.display = 'block';
  document.getElementById('steal-step-title').innerText = '盜壘結果';
  document.getElementById('steal-step-sub').innerText = `企圖：${pendingSteal.label}`;

  renderStealResultButtons();
}

function renderStealResultButtons(){
  const box = document.getElementById('steal-results');
  box.innerHTML = '';
  if (!pendingSteal) return;

  if (!pendingSteal.isDouble){
    const ok = document.createElement('button');
    ok.className = 'menu-btn';
    ok.style.background = '#16a085';
    ok.innerText = '成功（SB）';
    ok.onclick = () => commitStealSingle(true);

    const fail = document.createElement('button');
    fail.className = 'menu-btn';
    fail.style.background = '#c0392b';
    fail.innerText = '失敗（CS）';
    fail.onclick = () => commitStealSingle(false);

    box.appendChild(ok);
    box.appendChild(fail);
    return;
  }

  const both = document.createElement('button');
  both.className = 'menu-btn';
  both.style.background = '#16a085';
  both.innerText = '兩個都成功';
  both.onclick = () => commitStealDouble('both');

  const front = document.createElement('button');
  front.className = 'menu-btn';
  front.style.background = '#c0392b';
  front.innerText = '抓前壘跑者（另一位照跑）';
  front.onclick = () => commitStealDouble('front');

  const back = document.createElement('button');
  back.className = 'menu-btn';
  back.style.background = '#c0392b';
  back.innerText = '抓後壘跑者（另一位照跑）';
  back.onclick = () => commitStealDouble('back');

  box.appendChild(both);
  box.appendChild(front);
  box.appendChild(back);
}

function commitStealSingle(success){
  if (!pendingSteal) return;

  // 單盜失敗：抓該 move 的 from 那位
  if (success){
    applyRunnerEvent({
      type:'STEAL',
      label:`SB ${pendingSteal.label}`,
      moves: pendingSteal.moves,
      caughtBase: null,
      success:true
    });
  } else {
    const fromBase = pendingSteal.moves?.[0]?.from;
    applyRunnerEvent({
      type:'STEAL',
      label:`CS ${pendingSteal.label}`,
      moves: [],
      caughtBase: fromBase || null,
      success:false
    });
  }

  pendingSteal = null;
  document.getElementById('steal-section').style.display = 'none';
  closeSpecial();
}

function commitStealDouble(mode){
  if (!pendingSteal) return;

  const ordered = [...pendingSteal.moves].sort((a,b)=> (b.from - a.from));
  const frontMove = ordered[0];
  const backMove  = ordered[ordered.length - 1];

  if (mode === 'both'){
    applyRunnerEvent({
      type:'STEAL',
      label:`SB ${pendingSteal.label}`,
      moves: pendingSteal.moves,
      caughtBase:null,
      success:true,
      double:true,
      mode:'both'
    });
  }

  if (mode === 'front'){
    applyRunnerEvent({
      type:'STEAL',
      label:`CS(前) ${pendingSteal.label}`,
      moves: backMove ? [backMove] : [],
      caughtBase: frontMove?.from || null,
      success:false,
      double:true,
      mode:'front'
    });
  }

  if (mode === 'back'){
    applyRunnerEvent({
      type:'STEAL',
      label:`CS(後) ${pendingSteal.label}`,
      moves: frontMove ? [frontMove] : [],
      caughtBase: backMove?.from || null,
      success:false,
      double:true,
      mode:'back'
    });
  }

  pendingSteal = null;
  document.getElementById('steal-section').style.display = 'none';
  closeSpecial();
}

function backToStealAttempt(){
  pendingSteal = null;
  openStealChooser();
}

function cancelStealFlow(){
  pendingSteal = null;
  document.getElementById('steal-section').style.display = 'none';
}


function applyRunnerMoves(moves){
  const ordered = [...moves].sort((a,b)=> (b.from - a.from));
  let sc = 0;

  ordered.forEach(m => {
    const r = state.runners[m.from];
    if (!r) return;
    state.runners[m.from] = null;

    if (m.to >= 4){
      sc++;
      return;
    }
    state.runners[m.to] = r;
  });

  if (sc > 0) scoreRun(sc);
}

function removeRunnerAtBase(base){
  if (!state.runners[base]) return;

  state.runners[base] = null;
  addOut(); // 統一走出局流程
}

function getFCOptions(){
  const r = state.runners;
  const has1 = !!r[1], has2 = !!r[2], has3 = !!r[3];

  const opts = [];
  // FC 的核心：抓壘上跑者（常見：抓 2B 或抓 Home）
  if (has1){
    // 有一壘跑者時，最常見是抓二壘（封殺二壘跑者）
    opts.push({ label:'FC：抓二壘（1→2 被封殺，打者上一壘）', outBase:2, batterTo:1 });
  }
  if (has2){
    opts.push({ label:'FC：抓三壘（2→3 被封殺，打者上一壘）', outBase:3, batterTo:1 });
  }
  if (has3){
    opts.push({ label:'FC：抓本壘（3→本 被封殺，打者上一壘）', outBase:4, batterTo:1 });
  }

  return opts;
}

function commitFC(opt){
  // 最小版：只做「出局+1」與「打者上一壘」
  // outBase = 2/3/4 表示抓哪一壘的跑者（4=本壘）
  saveHist();
  const beforeSnap = snapshotForPlay();

  // 找到被抓的跑者：用「最高壓力」簡化：從對應前一壘抓
  // 例如 outBase=2 => 抓原本 1 壘跑者；outBase=3 => 抓原本 2 壘跑者；outBase=4 => 抓原本 3 壘跑者
  const map = {2:1, 3:2, 4:3};
  const fromBase = map[opt.outBase];
  if (fromBase && state.runners[fromBase]){
    state.runners[fromBase] = null;
    addOut();
  } else {
    // 沒對應跑者就不做（避免錯誤）
  }

  // 打者上一壘（不算安打，算 AB：這屬於打席結果）
  // 這裡用 applyRunnerEvent 會比較乾淨，但你目前的 applyRunnerEvent 還沒做 FC，
  // 所以先用最小寫法：直接放到一壘（若一壘有人先不處理推進，後續再加引擎）
  const batter = state.rosters[state.side][state.batterIdx[state.side]];
  if (!state.runners[1]) state.runners[1] = batter;

  // 棒次推進
  state.batterIdx[state.side] = (state.batterIdx[state.side] % 9) + 1;

  plays.push({
    seq: playSeq++,
    ts: Date.now(),
    type: 'special',
    label: 'FC',
    inning: state.inning,
    side: state.side,
    batter: currentBatterInfo(),
    before: beforeSnap,
    after: snapshotForPlay(),
    loc: null,
    meta: { type:'FC', ...opt }
  });

  updateUI();
  closeSpecial();
}

function getDPOptions(){
  const r = state.runners;
  const has1 = !!r[1], has2 = !!r[2], has3 = !!r[3];
  const opts = [];

  // 最小：常見 6-4-3：需要一壘有人（可抓二壘再抓一壘）
  if (has1){
    opts.push({ label:'DP：6-4-3（抓二壘 + 一壘）', kind:'643' });
    opts.push({ label:'DP：4-6-3（抓二壘 + 一壘）', kind:'463' });
  }
  // 也可加「本壘+一壘」但先留到進階

  return opts;
}

function commitDP(opt){
  saveHist();
  const beforeSnap = snapshotForPlay();

  // 最小版 DP：兩出局
  // 規則簡化：有一壘跑者時，視同「一壘跑者出局 + 打者出局」
  if (state.runners[1]) state.runners[1] = null;
  addOut();
  addOut();

  plays.push({
    seq: playSeq++,
    ts: Date.now(),
    type: 'special',
    label: 'DP',
    inning: state.inning,
    side: state.side,
    batter: currentBatterInfo(),
    before: beforeSnap,
    after: snapshotForPlay(),
    loc: null,
    meta: { type:'DP', ...opt }
  });

  updateUI();
  closeSpecial();
}

/**
 * 最小跑壘事件引擎
 * 只處理 runner 移動與出局
 */
function applyRunnerEvent(ev){
  saveHist();
  const beforeSnap = snapshotForPlay();

  // ===== 投手犯規 =====
  if (ev.type === 'BK'){
    // 壘上跑者全部推進一壘
    for (let b = 3; b >= 1; b--){
      if (state.runners[b]){
        if (b === 3){
          scoreRun(1);
          state.runners[3] = null;
        } else {
          state.runners[b+1] = state.runners[b];
          state.runners[b] = null;
        }
      }
    }
    // 打者上一壘
    state.runners[1] = state.rosters[state.side][state.batterIdx[state.side]];
    state.batterIdx[state.side] = (state.batterIdx[state.side] % 9) + 1;
  }

  // ===== 不死三振 =====
  if (ev.type === 'K_DROP'){
    state.runners[1] = state.rosters[state.side][state.batterIdx[state.side]];
    state.batterIdx[state.side] = (state.batterIdx[state.side] % 9) + 1;
  }

// ===== 盜壘（成功/失敗/雙盜抓一個）統一處理 =====
if (ev.type === 'STEAL'){
  if (ev.caughtBase){
    removeRunnerAtBase(ev.caughtBase);
  }


  if (Array.isArray(ev.moves) && ev.moves.length){
    applyRunnerMoves(ev.moves);
  }

  // 造成三出局 → 攻守交換提示（沿用你原本 CS 的邏輯）
  if (state.O >= 3){
    const nextSide = state.side === '上' ? '下' : '上';
    showNotice("攻守交換", `由 <b>${nextSide==='上'?'客隊':'主隊'}</b><br>第 <b>${state.batterIdx[nextSide]}</b> 棒開始打擊`, true);
  }
}

plays.push({
    seq: playSeq++,
    ts: Date.now(),
    type: 'special',
    label: ev.label,
    inning: state.inning,
    side: state.side,
    batter: currentBatterInfo(),
    before: beforeSnap,
    after: snapshotForPlay(),
    loc: null,
    meta: ev
  });

  updateUI();
}




  
/* === UI actions === */


function doBK(){
  if (gameConfig.gameOver) return;
  applyRunnerEvent({
    type: 'BK',
    label: 'BK',
  });
  closeSpecial();
}

function doHBP(){
  if (gameConfig.gameOver) return;
  saveHist();

  // 觸身球 = 投手投出一顆球
  state.pPitches[defendingSide()]++;

  execPlay('HBP', 1, 'special', {recordPoint:false, countPitch:false, saveHist:false});
  closeSpecial();
}

function openBallExtraMenu(){
  if (gameConfig.gameOver) return;
  document.getElementById('ball-extra-modal').style.display = 'block';
}

function closeBallExtra(){
  document.getElementById('ball-extra-modal').style.display = 'none';
}

function doPitchAdvance(kind){
  baseEditAdvanceByPitch(kind); // ← 你前一題寫好的那支
  closeBallExtra();
}

function doSB(){
  openStealChooser();
}

function getStealOptions() {
  const r = state.runners;
  const has1 = !!r[1];
  const has2 = !!r[2];
  const has3 = !!r[3];

  const opts = [];

  /* ===== 1、2 壘有人（你指定）===== */
  if (has1 && has2 && !has3) {
    opts.push(
      { label: '2壘盜3壘', moves: [{ from: 2, to: 3 }] },
      { label: '雙盜壘（1→2、2→3）', moves: [{ from: 2, to: 3 }, { from: 1, to: 2 }] }
    );
    return opts;
  }

  /* ===== 1、3 壘有人（你指定）===== */
  if (has1 && !has2 && has3) {
    opts.push(
      { label: '1壘盜2壘', moves: [{ from: 1, to: 2 }] },
      { label: '雙盜壘（1→2、3→本壘）', moves: [{ from: 3, to: 4 }, { from: 1, to: 2 }] }
    );
    return opts;
  }

  /* ===== 其他壘況仍保留單盜 ===== */
  if (has1 && !has2)
    opts.push({ label: '1壘盜2壘', moves: [{ from: 1, to: 2 }] });

  if (has2 && !has3)
    opts.push({ label: '2壘盜3壘', moves: [{ from: 2, to: 3 }] });

  if (has3)
    opts.push({ label: '3壘盜本壘', moves: [{ from: 3, to: 4 }] });

  return opts;
}

function doDroppedK(){
  if (gameConfig.gameOver) return;

  // 一壘有人 → 不成立
  if (state.runners[1]){
    showNotice('不死三振不成立', '一壘已有跑者，視為一般三振出局');
    saveHist();
    addOut();
    recordPlayEvent({
      type:'play',
      label:'K',
      loc:null,
      meta:{dropped:false}
    });
    updateUI();
    closeSpecial();
    return;
  }

  // 一壘空 → 不死三振成立
  applyRunnerEvent({
    type:'K_DROP',
    label:'K+WP'
  });
  closeSpecial();
}

  </script>


</body>
</html>


